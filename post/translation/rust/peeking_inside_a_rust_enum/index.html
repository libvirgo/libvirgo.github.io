<!doctype html><html lang dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="æœ¬è¯‘æ–‡è¯‘è‡ª Peeking inside a Rust enum
å‰è¨€ åœ¨æˆ‘æœ€è¿‘ Rust Q&amp;amp;A twitch é¢‘é“é‡Œ, æœ‰äº›äººæå‡ºäº†ä¸€ä¸ªçœ‹èµ·æ¥ç®€å•çš„é—®é¢˜: ä¸ºä»€ä¹ˆ small string ç±»å‹, åƒ SmartString or SmolStr å’Œ String æœ‰ç€ä¸€æ ·çš„å¤§å°, ä½†æ˜¯ small vec ç±»å‹, åƒ SmallVec å´è¦æ¯” Vec å¤§?
æˆ‘çŸ¥é“æˆ‘ä½¿ç”¨äº†ç®€å•ä½œä¸ºå½¢å®¹è¯, ä½†æ˜¯äº‹å®ä¸Šè¦äº†è§£è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬éœ€è¦ä¸€äº›èƒŒæ™¯çŸ¥è¯†
è¯‘è€…: äº¿ç‚¹ç‚¹&amp;hellip;
è¿™ä¸ªé—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆ? æˆ‘æœ€è¿‘è°ˆåˆ° Rust small string crates.
è¢«è¿™äº› crates å¯¼å‡ºçš„ç±»å‹å¯ä»¥é¿å…å¤šæ¬¡å†…å­˜åˆ†é…, å¹¶ä¸”é™ä½å†…å­˜ä½¿ç”¨é‡. è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª smartstring çš„ä»£ç ä½œä¸ºä¾‹å­.
use smartstring::{Compact, SmartString}; use std::mem::size_of_val; fn main() { let smart = SmartString::&amp;lt;Compact&amp;gt;::from(&amp;#34;hello world&amp;#34;); dbg!(size_of_val(&amp;amp;smart)); let stand = String::from(&amp;#34;hello world&amp;#34;); dbg!"><title>æ·±å…¥Rustæšä¸¾</title><link rel=canonical href=/post/translation/rust/peeking_inside_a_rust_enum/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="æ·±å…¥Rustæšä¸¾"><meta property="og:description" content="æœ¬è¯‘æ–‡è¯‘è‡ª Peeking inside a Rust enum
å‰è¨€ åœ¨æˆ‘æœ€è¿‘ Rust Q&amp;amp;A twitch é¢‘é“é‡Œ, æœ‰äº›äººæå‡ºäº†ä¸€ä¸ªçœ‹èµ·æ¥ç®€å•çš„é—®é¢˜: ä¸ºä»€ä¹ˆ small string ç±»å‹, åƒ SmartString or SmolStr å’Œ String æœ‰ç€ä¸€æ ·çš„å¤§å°, ä½†æ˜¯ small vec ç±»å‹, åƒ SmallVec å´è¦æ¯” Vec å¤§?
æˆ‘çŸ¥é“æˆ‘ä½¿ç”¨äº†ç®€å•ä½œä¸ºå½¢å®¹è¯, ä½†æ˜¯äº‹å®ä¸Šè¦äº†è§£è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬éœ€è¦ä¸€äº›èƒŒæ™¯çŸ¥è¯†
è¯‘è€…: äº¿ç‚¹ç‚¹&amp;hellip;
è¿™ä¸ªé—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆ? æˆ‘æœ€è¿‘è°ˆåˆ° Rust small string crates.
è¢«è¿™äº› crates å¯¼å‡ºçš„ç±»å‹å¯ä»¥é¿å…å¤šæ¬¡å†…å­˜åˆ†é…, å¹¶ä¸”é™ä½å†…å­˜ä½¿ç”¨é‡. è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª smartstring çš„ä»£ç ä½œä¸ºä¾‹å­.
use smartstring::{Compact, SmartString}; use std::mem::size_of_val; fn main() { let smart = SmartString::&amp;lt;Compact&amp;gt;::from(&amp;#34;hello world&amp;#34;); dbg!(size_of_val(&amp;amp;smart)); let stand = String::from(&amp;#34;hello world&amp;#34;); dbg!"><meta property="og:url" content="/post/translation/rust/peeking_inside_a_rust_enum/"><meta property="og:site_name" content><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Translation"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Enum"><meta property="article:published_time" content="2021-01-13T11:00:00+08:00"><meta property="article:modified_time" content="2021-01-13T15:00:00+08:00"><meta property="og:image" content="/post/translation/rust/peeking_inside_a_rust_enum/cover.png"><meta name=twitter:title content="æ·±å…¥Rustæšä¸¾"><meta name=twitter:description content="æœ¬è¯‘æ–‡è¯‘è‡ª Peeking inside a Rust enum
å‰è¨€ åœ¨æˆ‘æœ€è¿‘ Rust Q&amp;amp;A twitch é¢‘é“é‡Œ, æœ‰äº›äººæå‡ºäº†ä¸€ä¸ªçœ‹èµ·æ¥ç®€å•çš„é—®é¢˜: ä¸ºä»€ä¹ˆ small string ç±»å‹, åƒ SmartString or SmolStr å’Œ String æœ‰ç€ä¸€æ ·çš„å¤§å°, ä½†æ˜¯ small vec ç±»å‹, åƒ SmallVec å´è¦æ¯” Vec å¤§?
æˆ‘çŸ¥é“æˆ‘ä½¿ç”¨äº†ç®€å•ä½œä¸ºå½¢å®¹è¯, ä½†æ˜¯äº‹å®ä¸Šè¦äº†è§£è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬éœ€è¦ä¸€äº›èƒŒæ™¯çŸ¥è¯†
è¯‘è€…: äº¿ç‚¹ç‚¹&amp;hellip;
è¿™ä¸ªé—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆ? æˆ‘æœ€è¿‘è°ˆåˆ° Rust small string crates.
è¢«è¿™äº› crates å¯¼å‡ºçš„ç±»å‹å¯ä»¥é¿å…å¤šæ¬¡å†…å­˜åˆ†é…, å¹¶ä¸”é™ä½å†…å­˜ä½¿ç”¨é‡. è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª smartstring çš„ä»£ç ä½œä¸ºä¾‹å­.
use smartstring::{Compact, SmartString}; use std::mem::size_of_val; fn main() { let smart = SmartString::&amp;lt;Compact&amp;gt;::from(&amp;#34;hello world&amp;#34;); dbg!(size_of_val(&amp;amp;smart)); let stand = String::from(&amp;#34;hello world&amp;#34;); dbg!"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/post/translation/rust/peeking_inside_a_rust_enum/cover.png"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hubab1a6f26c99bd4005799835b3b49dcb_56897_300x0_resize_box_3.png width=300 height=321 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/></a></h1><h2 class=site-description>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2></div></header><ol class=menu id=main-menu><li><a href=/page/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/translation/rust/peeking_inside_a_rust_enum/><img src=/post/translation/rust/peeking_inside_a_rust_enum/cover_huf0a0302560a2de312014d03b723c5fe2_142416_800x0_resize_box_3.png srcset="/post/translation/rust/peeking_inside_a_rust_enum/cover_huf0a0302560a2de312014d03b723c5fe2_142416_800x0_resize_box_3.png 800w, /post/translation/rust/peeking_inside_a_rust_enum/cover_huf0a0302560a2de312014d03b723c5fe2_142416_1600x0_resize_box_3.png 1600w" width=800 height=435 loading=lazy alt="Featured image of post æ·±å…¥Rustæšä¸¾"></a></div><div class=article-details><header class=article-category><a href=/categories/rust/>Rust</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/translation/rust/peeking_inside_a_rust_enum/>æ·±å…¥Rustæšä¸¾</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 13, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>23 minute read</time></div></footer></div></header><section class=article-content><blockquote><p>æœ¬è¯‘æ–‡è¯‘è‡ª <a class=link href=https://fasterthanli.me/articles/peeking-inside-a-rust-enum target=_blank rel=noopener>Peeking inside a Rust enum</a></p></blockquote><hr><h1 id=å‰è¨€>å‰è¨€</h1><p>åœ¨æˆ‘æœ€è¿‘ <code>Rust Q&A</code> <code>twitch</code> é¢‘é“é‡Œ, æœ‰äº›äººæå‡ºäº†ä¸€ä¸ªçœ‹èµ·æ¥ç®€å•çš„é—®é¢˜: ä¸ºä»€ä¹ˆ <code>small string</code> ç±»å‹, åƒ <code>SmartString</code> or <code>SmolStr</code> å’Œ <code>String</code> æœ‰ç€ä¸€æ ·çš„å¤§å°, ä½†æ˜¯ <code>small vec</code> ç±»å‹, åƒ <code>SmallVec</code> å´è¦æ¯” <code>Vec</code> å¤§?</p><p>æˆ‘çŸ¥é“æˆ‘ä½¿ç”¨äº†ç®€å•ä½œä¸ºå½¢å®¹è¯, ä½†æ˜¯äº‹å®ä¸Šè¦äº†è§£è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬éœ€è¦ä¸€äº›èƒŒæ™¯çŸ¥è¯†</p><blockquote><p>è¯‘è€…: äº¿ç‚¹ç‚¹&mldr;</p></blockquote><h2 id=è¿™ä¸ªé—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆ>è¿™ä¸ªé—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆ?</h2><p>æˆ‘æœ€è¿‘è°ˆåˆ° <code>Rust</code> <a class=link href=https://fasterthanli.me/articles/small-strings-in-rust target=_blank rel=noopener>small string crates</a>.</p><p>è¢«è¿™äº› <code>crates</code> å¯¼å‡ºçš„ç±»å‹å¯ä»¥é¿å…å¤šæ¬¡å†…å­˜åˆ†é…, å¹¶ä¸”é™ä½å†…å­˜ä½¿ç”¨é‡. è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª <a class=link href=https://lib.rs/crates/smartstring target=_blank rel=noopener>smartstring</a> çš„ä»£ç ä½œä¸ºä¾‹å­.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> smartstring::{Compact, SmartString};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of_val;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart <span style=color:#f92672>=</span> SmartString::<span style=color:#f92672>&lt;</span>Compact<span style=color:#f92672>&gt;</span>::from(<span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>    dbg!(size_of_val(<span style=color:#f92672>&amp;</span>smart));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>    dbg!(size_of_val(<span style=color:#f92672>&amp;</span>stand));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:6<span style=color:#f92672>]</span> size_of_val<span style=color:#f92672>(</span>&amp;smart<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:9<span style=color:#f92672>]</span> size_of_val<span style=color:#f92672>(</span>&amp;stand<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span></code></pre></div><p>æ­£å¦‚ä½ çœ‹åˆ°çš„, åŒæ ·ä¹Ÿæ˜¯æœ€åˆçš„é—®é¢˜æè¿°çš„é‚£æ ·, è¿™ä¸¤ä¸ªç±»å‹çš„å¤§å°æ˜¯ç›¸åŒçš„.</p><p>æ˜¯çš„, è¿™å½“ç„¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•…äº‹, åœ¨è¿™ä¸ªç‰¹åˆ«çš„ä¾‹å­ä¸­, <code>smart</code> ä»¥ <code>inline</code> çš„æ–¹å¼å­˜å‚¨å®ƒçš„å€¼(åœ¨æ ˆä¸Š), è€Œæ ‡å‡†åº“å°†å€¼å­˜å‚¨åœ¨å †ä¸Š:</p><p>å¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“æ¯ä¸ªç±»å‹åˆ°åº•æ€»å…±ä½¿ç”¨äº†å¤šå°‘å†…å­˜, æˆ‘ä»¬å¯ä»¥è¿™æ ·åš:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart <span style=color:#f92672>=</span> SmartString::<span style=color:#f92672>&lt;</span>Compact<span style=color:#f92672>&gt;</span>::from(<span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>    dbg!(size_of_val(<span style=color:#f92672>&amp;</span>smart));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>    dbg!(size_of_val(<span style=color:#f92672>&amp;</span>stand) <span style=color:#f92672>+</span> stand.capacity());
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:6<span style=color:#f92672>]</span> size_of_val<span style=color:#f92672>(</span>&amp;smart<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:9<span style=color:#f92672>]</span> size_of_val<span style=color:#f92672>(</span>&amp;stand<span style=color:#f92672>)</span> + stand.capacity<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>35</span>
</span></span></code></pre></div><p>å…¸å‹çš„, åœ¨ <code>Linux 64-bit</code> ç³»ç»Ÿä¸­æ ˆå’Œå †åœ¨è™šæ‹Ÿåœ°å€ä¸­çš„ç©ºé—´ç›¸å·®å¾ˆè¿œ, è¿™æ„å‘³ç€æˆ‘ä»¬å¦‚æœæ‰“å°å­—ç¬¦ä¸²çš„å…ƒæ•°æ®çš„åœ°å€å’Œå†…å®¹çš„åœ°å€, æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°:</p><ul><li><code>SmartString</code> çš„å…ƒæ•°æ®å’Œå†…å®¹åœ¨ç›¸é‚»çš„ä½ç½®.</li><li><code>String</code> çš„å…ƒæ•°æ®å’Œå†…å®¹ç›¸è·å¾ˆè¿œ.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> smartstring::{Compact, SmartString};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart <span style=color:#f92672>=</span> SmartString::<span style=color:#f92672>&lt;</span>Compact<span style=color:#f92672>&gt;</span>::from(<span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart_meta <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>smart <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart_data <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>smart.as_bytes()[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    dbg!((smart_meta, smart_data));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand_meta <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>stand <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand_data <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>stand.as_bytes()[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    dbg!((stand_meta, stand_data));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:7<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>smart_meta, smart_data<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffce4cf4728,
</span></span><span style=display:flex><span>    0x00007ffce4cf4729,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:12<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>stand_meta, stand_data<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffce4cf47f8,
</span></span><span style=display:flex><span>    0x0000555f87686a60,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>ä¸! åªæœ‰åœ¨å°äº24å­—èŠ‚çš„æ—¶å€™æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šçš„, å°±å’Œ <code>String</code> ä¸€æ ·. æˆ‘ä»¬ç”¨ç¨å¾®é•¿ä¸€ç‚¹çš„å­—ç¬¦ä¸²æ¥çœ‹çœ‹.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> smartstring::{Compact, SmartString};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> input <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Turns out you can blame your tools *and* be a good craftsperson. Who knew?&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart <span style=color:#f92672>=</span> SmartString::<span style=color:#f92672>&lt;</span>Compact<span style=color:#f92672>&gt;</span>::from(input);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart_meta <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>smart <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> smart_data <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>smart.as_bytes()[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    dbg!((smart_meta, smart_data));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand <span style=color:#f92672>=</span> String::from(input);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand_meta <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>stand <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> stand_data <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>stand.as_bytes()[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>    dbg!((stand_meta, stand_data));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:9<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>smart_meta, smart_data<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffd460d0268,
</span></span><span style=display:flex><span>    0x0000555f4636ca30,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:14<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>stand_meta, stand_data<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffd460d0338,
</span></span><span style=display:flex><span>    0x0000555f4636cac0,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>&mldr;ç„¶åæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªç±»å‹çš„å†…å®¹ç°åœ¨éƒ½æ”¾åœ¨å †ä¸Šäº†.</p><h2 id=ä¸€ä¸ªå•è¯-å¤šç§æ„ä¹‰>ä¸€ä¸ªå•è¯, å¤šç§æ„ä¹‰</h2><p>å¦‚æœä½ æœ‰ç€ <code>C/C++/Java/C#</code> çš„è¯­è¨€èƒŒæ™¯, ä¸€ä¸ª <code>enum</code> ä»…ä»…æ„å‘³ç€ä¸€ä¸ª <code>Integer</code> ç±»å‹, åªæ˜¯å®ƒçš„å€¼æœ‰ç€è‡ªå·±çš„æ„ä¹‰.</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª <code>C</code> çš„ä¾‹å­:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> Drink {
</span></span><span style=display:flex><span>    Water,
</span></span><span style=display:flex><span>    Soda,
</span></span><span style=display:flex><span>    Juice,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> Drink dri <span style=color:#f92672>=</span> Soda;
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;dri = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, dri);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(dri) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(dri));
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(int) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™é‡Œ, æˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªæšä¸¾ç±»å‹ <code>enum Drink</code>, æœ‰ä¸‰ä¸ªå˜ä½“, ä¸è¿‡ä»…ä»…æ˜¯ä»0å¼€å§‹çš„æ•°å­—, æ‰€ä»¥æˆ‘ä»¬æœ‰ <code>Water = 0</code>, <code>Soda = 1</code>, <code>Juice = 2</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>dri <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>dri<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>int<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span></code></pre></div><p>ç„¶è€Œæˆ‘ä¸æ˜¯å¾ˆå–œæ¬¢è¿™ä¸ªä»£ç , æˆ‘ä¸æƒ³è¦é¢å¤–çš„é™å®šè¯, å¹¶ä¸”æƒ³è¦æˆ‘çš„å˜ä½“æœ‰ç€è‡ªå·±çš„å‘½åç©ºé—´, ä½†åœ¨ <code>C</code> é‡Œé¢æˆ‘ä»¬éœ€è¦è‡ªå·±åšè¿™äº›äº‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// this could also be done in two separate declarations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> Drink {
</span></span><span style=display:flex><span>    Drink_Water,
</span></span><span style=display:flex><span>    Drink_Soda,
</span></span><span style=display:flex><span>    Drink_Juice,
</span></span><span style=display:flex><span>} Drink;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    Drink dri <span style=color:#f92672>=</span> Drink_Soda;
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;dri = %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, dri);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(dri) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(dri));
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(int) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ahhh, å¥½å¤šäº†. ä½†æ˜¯è¿™é‡Œä»ç„¶æœ‰å…¶å®ƒçš„ä¸œè¥¿æˆ‘ä¸æ˜¯ç‰¹åˆ«å–œæ¬¢, åƒæ˜¯ <code>C</code> çš„ <code>switch</code>. ä¸‹é¢çš„ä»£ç æ˜¯é”™è¯¯çš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> Drink {
</span></span><span style=display:flex><span>    Drink_Water,
</span></span><span style=display:flex><span>    Drink_Soda,
</span></span><span style=display:flex><span>    Drink_Juice,
</span></span><span style=display:flex><span>} Drink;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_drink</span>(Drink dri) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (dri) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Drink_Water:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;It&#39;s water!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Drink_Soda:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;It&#39;s soda!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Drink_Juice:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;It&#39;s juice!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    print_drink(Drink_Soda);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ­£ç¡®çš„ä»£ç æ˜¯åœ¨æ¯ä¸ª <code>case</code> è¯­å¥çš„ç»“å°¾éƒ½ä½¿ç”¨ <code>break</code>. è¿™æ˜¯åˆšèµ·æ­¥çš„å¼€å‘äººå‘˜å¾ˆæ—©å°±åº”è¯¥äº†è§£çš„äº‹æƒ…ä¹‹ä¸€.</p><p>å³ä½¿æˆ‘ä»¬ä¿®å¤äº† <code>switch</code> çš„é—®é¢˜, è¿˜æœ‰ä»¶æˆ‘ä¸å–œæ¬¢ <code>C</code> æšä¸¾çš„äº‹æƒ…, é‚£å°±æ˜¯æ²¡ä»€ä¹ˆå¯ä»¥é˜»æ­¢æˆ‘ä¼ é€’ä¸€ä¸ªæ— æ„ä¹‰çš„å€¼:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> Drink {
</span></span><span style=display:flex><span>    Drink_Water,
</span></span><span style=display:flex><span>    Drink_Soda,
</span></span><span style=display:flex><span>    Drink_Juice,
</span></span><span style=display:flex><span>} Drink;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_drink</span>(Drink dri) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (dri) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Drink_Water:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;It&#39;s water!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Drink_Soda:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;It&#39;s soda!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Drink_Juice:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;It&#39;s juice!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    print_drink(<span style=color:#ae81ff>47</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span></code></pre></div><p>ç°åœ¨, å¦‚æœæˆ‘ä»¬çœ‹çœ‹ <code>Rust</code> çš„æšä¸¾&mldr; è¿™æ˜¯ä¸ªå®Œå…¨ä¸åŒçš„äº‹æƒ….</p><p>è®©æˆ‘ä»¬å°½é‡å†™ä¸€ä¸ªç›¸åŒçš„ç¨‹åº.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of_val;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Drink</span> {
</span></span><span style=display:flex><span>    Water,
</span></span><span style=display:flex><span>    Soda,
</span></span><span style=display:flex><span>    Juice,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> dri <span style=color:#f92672>=</span> Drink::Water;
</span></span><span style=display:flex><span>    dbg!(size_of_val(<span style=color:#f92672>&amp;</span>dri));
</span></span><span style=display:flex><span>    dbg!(dri <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u32</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>warning: variant is never constructed: <span style=color:#e6db74>`</span>Soda<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span> --&gt; src/main.rs:5:5
</span></span><span style=display:flex><span>  |
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span> |     Soda,
</span></span><span style=display:flex><span>  |     ^^^^
</span></span><span style=display:flex><span>  |
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span> note: <span style=color:#e6db74>`</span><span style=color:#75715e>#[warn(dead_code)]` on by default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>warning: variant is never constructed: <span style=color:#e6db74>`</span>Juice<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span> --&gt; src/main.rs:6:5
</span></span><span style=display:flex><span>  |
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span> |     Juice,
</span></span><span style=display:flex><span>  |     ^^^^^
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>warning: <span style=color:#ae81ff>2</span> warnings emitted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> size_of_val<span style=color:#f92672>(</span>&amp;dri<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:12<span style=color:#f92672>]</span> dri as u32 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>é‚£ä¹ˆæˆ‘ä»¬æ˜æ˜¾åœ°å¾—åˆ°äº†ä»€ä¹ˆå¥½å¤„å‘¢?</p><p>å¯¹çš„, ä½†é‚£å¹¶ä¸æ˜¯å…¨éƒ¨! ç¼–è¯‘å™¨è­¦å‘Šæˆ‘ä»¬æœ‰æ²¡æœ‰ä½¿ç”¨çš„å˜ä½“, å¹¶ä¸”æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç»™è¿™ä¸ªæšä¸¾æ´¾ç”Ÿä¸€ä¸ª <code>Debug</code> trait çš„å®ç°:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Drink</span> {
</span></span><span style=display:flex><span>    Water,
</span></span><span style=display:flex><span>    Soda,
</span></span><span style=display:flex><span>    Juice,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>Drink::Water);
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>Drink::Juice);
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>Drink::Soda);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_drink</span>(dri: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Drink</span>) {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;{:?}&#34;</span>, dri);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>Water
</span></span><span style=display:flex><span>Juice
</span></span><span style=display:flex><span>Soda
</span></span></code></pre></div><p>&mldr;å¹¶ä¸”å‡å¦‚æˆ‘ä»¬ä¸é‚£ä¹ˆåš, æˆ‘ä»¬ä¹Ÿèƒ½ä½¿ç”¨ <code>match</code> è€Œä¸æ˜¯ <code>switch</code>, <code>match</code> ä¼šæ£€æŸ¥æ˜¯å¦åŒ¹é…äº†æšä¸¾çš„æ‰€æœ‰å˜ä½“, ä¸¾ä¸ªä¾‹å­, ä¸‹é¢çš„ä»£ç ä¸èƒ½é€šè¿‡ç¼–è¯‘:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_drink</span>(dri: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Drink</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> dri {
</span></span><span style=display:flex><span>        Drink::Water <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s water!&#34;</span>),
</span></span><span style=display:flex><span>        Drink::Soda <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s soda!&#34;</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>error<span style=color:#f92672>[</span>E0004<span style=color:#f92672>]</span>: non-exhaustive patterns: <span style=color:#e6db74>`</span>&amp;Juice<span style=color:#e6db74>`</span> not covered
</span></span><span style=display:flex><span>  --&gt; src/main.rs:15:11
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>  | / enum Drink <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>  | |     Water,
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>  | |     Soda,
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>  | |     Juice,
</span></span><span style=display:flex><span>   | |     ----- not covered
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>  | | <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>   | |_- <span style=color:#e6db74>`</span>Drink<span style=color:#e6db74>`</span> defined here
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#ae81ff>15</span> |       match dri <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   |             ^^^ pattern <span style=color:#e6db74>`</span>&amp;Juice<span style=color:#e6db74>`</span> not covered
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span>   <span style=color:#f92672>=</span> help: ensure that all possible cases are being handled, possibly by adding wildcards or more match arms
</span></span><span style=display:flex><span>   <span style=color:#f92672>=</span> note: the matched value is of type <span style=color:#e6db74>`</span>&amp;Drink<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>ç¼–è¯‘å™¨ç»™å‡ºäº†ä¸¤ç§å¯èƒ½çš„æ–¹æ³•æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜, æˆ–æ˜¯æ·»åŠ ä¸€ä¸ªé€šé…ç¬¦:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_drink</span>(dri: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Drink</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> dri {
</span></span><span style=display:flex><span>        Drink::Water <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s water!&#34;</span>),
</span></span><span style=display:flex><span>        Drink::Soda <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s soda!&#34;</span>),
</span></span><span style=display:flex><span>        _ <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s something we don&#39;t know about!&#34;</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ–è€…æ˜¯è¦†ç›–åˆ°æ‰€æœ‰çš„æƒ…å†µ:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_drink</span>(dri: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Drink</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> dri {
</span></span><span style=display:flex><span>        Drink::Water <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s water!&#34;</span>),
</span></span><span style=display:flex><span>        Drink::Soda <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s soda!&#34;</span>),
</span></span><span style=display:flex><span>        Drink::Juice <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;it&#39;s juice!&#34;</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è®²åˆ° <code>match</code>, å®ƒä¹Ÿæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼, æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™ä¹ˆåš:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_drink</span>(dri: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Drink</span>) {
</span></span><span style=display:flex><span>    println!(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;{}&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> dri {
</span></span><span style=display:flex><span>            Drink::Water <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;it&#39;s water!&#34;</span>,
</span></span><span style=display:flex><span>            Drink::Soda <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;it&#39;s soda!&#34;</span>,
</span></span><span style=display:flex><span>            Drink::Juice <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;it&#39;s juice!&#34;</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å°½ç®¡å°±æˆ‘ä¸ªäººè€Œè¨€, æˆ‘å¯èƒ½æ›´å€¾å‘äºè¿™æ ·å†™:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_drink</span>(dri: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Drink</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> dri {
</span></span><span style=display:flex><span>        Drink::Water <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;water&#34;</span>,
</span></span><span style=display:flex><span>        Drink::Soda <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;soda&#34;</span>,
</span></span><span style=display:flex><span>        Drink::Juice <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;juice&#34;</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;it&#39;s {}!&#34;</span>, name)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è®©æˆ‘ä»¬æƒ³æƒ³, æˆ‘ä»¬è¿˜æŠ±æ€¨äº† <code>C</code> æšä¸¾çš„ä»€ä¹ˆåœ°æ–¹?</p><p>å¯¹! è®©æˆ‘ä»¬è¯•è¯•:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>Drink::Water);
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>Drink::Juice);
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>Drink::Soda);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> val: <span style=color:#a6e22e>Drink</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> <span style=color:#66d9ef>as</span> Drink;
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>val);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>error<span style=color:#f92672>[</span>E0605<span style=color:#f92672>]</span>: non-primitive cast: <span style=color:#e6db74>`</span>i32<span style=color:#e6db74>`</span> as <span style=color:#e6db74>`</span>Drink<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>  --&gt; src/main.rs:13:22
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span><span style=color:#ae81ff>13</span> |     let val: Drink <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> as Drink;
</span></span><span style=display:flex><span>   |                      ^^^^^^^^^^
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span>   <span style=color:#f92672>=</span> note: an <span style=color:#e6db74>`</span>as<span style=color:#e6db74>`</span> expression can only be used to convert between primitive types. Consider using the <span style=color:#e6db74>`</span>From<span style=color:#e6db74>`</span> traitt
</span></span></code></pre></div><p>Ah, è¿™çœ‹èµ·æ¥å¹¶ä¸èƒ½å·¥ä½œ! ç„¶è€Œåœ¨æŸäº›æƒ…å½¢ä¸­æˆ‘ä»¬å¯èƒ½éœ€è¦è¿™ä¹ˆåš, æˆ‘ä»¬å¯ä»¥è§£æä¸€ä¸ªäºŒè¿›åˆ¶æ ¼å¼, å¹¶ä¸”å·²ç»ç¡®ä¿æ£€æŸ¥è¿™ä¸ªæ•°å­—ç±»å‹çš„å€¼åœ¨è¿™ä¸ªæšä¸¾ä¸­æ˜¯æœ‰æ„ä¹‰çš„ - é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>transmute</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Drink</span> {
</span></span><span style=display:flex><span>    Water,
</span></span><span style=display:flex><span>    Soda,
</span></span><span style=display:flex><span>    Juice,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> juice_from_binary_format <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> val: <span style=color:#a6e22e>Drink</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { std::mem::transmute(juice_from_binary_format <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u8</span>) };
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>val);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_drink</span>(dri: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>Drink</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> name <span style=color:#f92672>=</span> <span style=color:#66d9ef>match</span> dri {
</span></span><span style=display:flex><span>        Drink::Water <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;water&#34;</span>,
</span></span><span style=display:flex><span>        Drink::Soda <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;soda&#34;</span>,
</span></span><span style=display:flex><span>        Drink::Juice <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;juice&#34;</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;it&#39;s {}!&#34;</span>, name)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>it<span style=color:#ae81ff>\&#39;</span>s juice!
</span></span></code></pre></div><p>å½“å‰, é€šå¸¸æˆ‘ä»¬å¸Œæœ›ç»™è¿™ä¸ªä¸å®‰å…¨æ“ä½œæä¾›ä¸€ä¸ªå®‰å…¨çš„æ¥å£:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::convert::{TryFrom, TryInto};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Drink</span> {
</span></span><span style=display:flex><span>    Water,
</span></span><span style=display:flex><span>    Soda,
</span></span><span style=display:flex><span>    Juice,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> TryFrom<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> Drink {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Error</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;&#39;</span>static <span style=color:#66d9ef>str</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>try_from</span>(x: <span style=color:#66d9ef>i32</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Self, Self::Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> x {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span><span style=color:#f92672>..=</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>=&gt;</span> Ok(<span style=color:#66d9ef>unsafe</span> { std::mem::transmute(x <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u8</span>) }),
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> Err(<span style=color:#e6db74>&#34;invalid Drink value&#34;</span>),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> juice_from_binary_format: <span style=color:#66d9ef>i32</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> val: <span style=color:#a6e22e>Drink</span> <span style=color:#f92672>=</span> juice_from_binary_format.try_into().unwrap();
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>val);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> invalid_value: <span style=color:#66d9ef>i32</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> val: <span style=color:#a6e22e>Drink</span> <span style=color:#f92672>=</span> invalid_value.try_into().unwrap();
</span></span><span style=display:flex><span>    print_drink(<span style=color:#f92672>&amp;</span>val);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>it<span style=color:#ae81ff>\&#39;</span>s juice!
</span></span><span style=display:flex><span>thread <span style=color:#e6db74>&#39;main&#39;</span> panicked at <span style=color:#e6db74>&#39;called `Result::unwrap()` on an `Err` value: &#34;invalid Drink value&#34;&#39;</span>, src/main.rs:27:22
</span></span><span style=display:flex><span>note: run with <span style=color:#e6db74>`</span>RUST_BACKTRACE<span style=color:#f92672>=</span>1<span style=color:#e6db74>`</span> environment variable to display a backtrace
</span></span></code></pre></div><p>å¹¶ä¸”æˆ‘ä»¬çš„å¿«ä¹è¿˜å¹¶ä¸æ­¢æ­¥äºæ­¤.</p><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æ‰“å°æˆ‘ä»¬çš„æšä¸¾å¤§å°ä¹ˆ? è®©æˆ‘ä»¬æ¥ <a class=link href=https://en.wikipedia.org/wiki/Memory_refresh target=_blank rel=noopener>refresh out memory</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Drink</span> {
</span></span><span style=display:flex><span>    Water,
</span></span><span style=display:flex><span>    Soda,
</span></span><span style=display:flex><span>    Juice,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>Drink<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> size_of::&lt;Drink&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>å•ä½æ˜¯å­—èŠ‚, æ‰€ä»¥è¿™é‡Œæ˜¾ç¤ºæˆ‘ä»¬çš„æšä¸¾åªæœ‰ä¸€ä¸ªå­—èŠ‚.</p><p>è®©æˆ‘ä»¬ä¸ <code>C</code> çš„å¯¹æ¯”ä¸‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> Drink {
</span></span><span style=display:flex><span>    Drink_Water,
</span></span><span style=display:flex><span>    Drink_Soda,
</span></span><span style=display:flex><span>    Drink_Juice,
</span></span><span style=display:flex><span>} Drink;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(Drink) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(Drink));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>Drink<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span></code></pre></div><p>è¿™é‡Œæšä¸¾æœ‰è¶³è¶³4ä¸ªå­—èŠ‚, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿‘ä¼¼åœ°è¯´ <code>Rust</code> çš„æšä¸¾æ˜¯ <code>u8</code>, <code>C</code> æšä¸¾æ˜¯ <code>u32</code>.</p><p>å¦‚æœ <code>Rust</code> çš„æšä¸¾è¶…è¿‡256ä¸ªå˜ä½“å‘¢?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Drink</span> {
</span></span><span style=display:flex><span>    Variant0,
</span></span><span style=display:flex><span>    Variant1,
</span></span><span style=display:flex><span>    Variant2,
</span></span><span style=display:flex><span>    Variant3,
</span></span><span style=display:flex><span>    Variant4,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// (etc.)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Variant252,
</span></span><span style=display:flex><span>    Variant253,
</span></span><span style=display:flex><span>    Variant254,
</span></span><span style=display:flex><span>    Variant255,
</span></span><span style=display:flex><span>    Variant256,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>Drink<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>è¯‘è€…: <a class=link href=https://en.wikipedia.org/wiki/Off-by-one_error#Fencepost_error target=_blank rel=noopener>counting the fences, when you should be counting the posts.</a></p></blockquote><p>ä¸ç®¡æ€æ ·, æˆ‘ä»¬å…ˆçœ‹çœ‹ç°åœ¨çš„æšä¸¾å¤§å°?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:265<span style=color:#f92672>]</span> size_of::&lt;Drink&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>2ä¸ªå­—èŠ‚! çœ‹èµ·æ¥åˆåƒæ˜¯ <code>u16</code>.</p><p>å½“ç„¶çœ‹èµ·æ¥åƒå¹¶ä¸æ˜¯ä¸€ä¸ªä¸“ä¸šæœ¯è¯­ - ä¸“ä¸šæœ¯è¯­åº”è¯¥æ˜¯ &ldquo;representation&rdquo;. ä¸€ä¸ª <code>Rust</code> æšä¸¾æ˜¯å¯¹ç‰¹å®šæ•´æ•°ç±»å‹çš„æŠ½è±¡.</p><p>è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬åŸæ¥çš„ <code>Drink</code>:</p><p>æ¦‚å¿µä¸Š, <code>Drink</code> åªæœ‰ä¸‰ä¸ªæœ‰æ„ä¹‰çš„å€¼, ä½†æ˜¯å®ƒçš„è¡¨ç°æ˜¯ä¸€ä¸ª <code>u8</code>, èƒ½æŒæœ‰256ä¸ªä¸åŒçš„å€¼. è¿™å°±æ˜¯ä½ ä¸ºä»€ä¹ˆæ€»æ˜¯èƒ½æŠŠ <code>Drink</code> è½¬ä¸º <code>u8</code>, ä½†æ˜¯æŠŠ <code>u8</code> è½¬ä¸º <code>Drink</code> å´æ˜¯ä¸€ä¸ªå®¹æ˜“å‡ºé”™çš„æ“ä½œ.</p><p>å¯¹çš„! æ½œåœ¨çš„ <code>Drink</code> ä½œä¸ºä¸€ä¸ª <code>u8</code> åº”è¯¥æ€»æ˜¯ä¸º0, 1æˆ–è€…2, è¿™è¢«ç§°ä¸ºä¸å˜ä½“(invariant). å¦‚æœæˆ‘ä»¬ç ´åäº†è¿™ä¸ªä¸å˜ä½“, æˆ‘ä»¬çš„ä»£ç å°±ä¸æ˜¯é‚£ä¹ˆå¥å£®äº†.</p><p>åœ¨ <code>Rust</code>, ç ´åä¸å˜ä½“éœ€è¦ä½¿ç”¨ <code>unsafe</code> ä»£ç :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::transmute;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, PartialEq)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Drink</span> {
</span></span><span style=display:flex><span>    Water,
</span></span><span style=display:flex><span>    Soda,
</span></span><span style=display:flex><span>    Juice,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// woops! that&#39;s unsound.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> d: <span style=color:#a6e22e>Drink</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { transmute(<span style=color:#ae81ff>15_</span><span style=color:#66d9ef>u8</span>) };
</span></span><span style=display:flex><span>    dbg!(<span style=color:#f92672>&amp;</span>d);
</span></span><span style=display:flex><span>    dbg!(d <span style=color:#f92672>==</span> Drink::Juice);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:14<span style=color:#f92672>]</span> &amp;d <span style=color:#f92672>=</span> Juice
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:15<span style=color:#f92672>]</span> d <span style=color:#f92672>==</span> Drink::Juice <span style=color:#f92672>=</span> false
</span></span></code></pre></div><p>é—®é¢˜çš„å…³é”®åœ¨äºä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…éƒ½å¯ä»¥äº¤ç”±è®¡ç®—æœºå»åš(æ„å‘³ç€éœ€è¦ä½ è‡ªå·±å»åš), å¯ä»¥ä½¿ç”¨ <code>Rust</code> çš„æ¨¡å‹æ£€æŸ¥. å› ä¸ºç§ç§åŸå› , ä½ ä»ç„¶éœ€è¦ <code>unsafe</code> ä»£ç .</p><p>è¿™å¹¶ä¸æ„å‘³æœ‰ç€ä¸¤ç§ <code>Rust</code>, ä»…ä»…æ„å‘³ç€ä¸åŒçš„é£é™©ä»¥åŠä¸åŒçš„å¯ä¿¡ä»»ç­‰çº§.</p><p>å¦‚æœä½ ç›¸ä¿¡ <code>Rust</code> æ ¸å¿ƒå›¢é˜Ÿå¯ä»¥æ ¹é™¤æ ‡å‡†åº“ä¸­çš„ä¸å¥å…¨ä¹‹å¤„, é‚£ä¹ˆä½ ç”šè‡³å°±å¯ä»¥è®©å›¢é˜Ÿä¸­çš„åˆçº§äººå‘˜åœ¨æ­¤åŸºç¡€ä¸Šç¼–å†™å— <code>Rust</code> å®‰å…¨ä¿è¯çš„ <code>safe code</code>.</p><h2 id=rustæšä¸¾ä¸æ­¢äºæ­¤>Rustæšä¸¾ä¸æ­¢äºæ­¤</h2><p>Cool bearæ—©å…ˆè¯´ <code>SmartString</code> æœ‰ç€ä¹°ä¸€é€ä¸€çš„å¤„ç†å­—ç¬¦ä¸²çš„æ–¹å¼. Cool bearæ˜¯å¯¹çš„!</p><p>è®©æˆ‘ä»¬æ¥è‡ªå·±åšä¸€ä¸ª <code>two-for-one</code> çš„å¤„ç†æ–¹å¼:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UserID</span> {
</span></span><span style=display:flex><span>    Number(<span style=color:#66d9ef>u64</span>),
</span></span><span style=display:flex><span>    Text(String),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>UserID</code> æ˜¯ä¸€ä¸ªèšåˆç±»å‹, ä¸€ä¸ª <code>UserID</code> çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ª <code>UserID::Number</code> å˜ä½“, æˆ–æ˜¯ä¸€ä¸ª <code>UserID::Text</code> å˜ä½“.å¦‚æœæˆ‘ä»¬æƒ³å¯¹å®ƒçš„å†…å®¹åšäº›æ“ä½œ, æˆ‘ä»¬éœ€è¦ç”¨æ¨¡å¼åŒ¹é…:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_user_id</span>(id: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>UserID</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>match</span> id {
</span></span><span style=display:flex><span>        UserID::Number(n) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            println!(<span style=color:#e6db74>&#34;user id number {}&#34;</span>, n);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        UserID::Text(s) <span style=color:#f92672>=&gt;</span> println!(<span style=color:#e6db74>&#34;user id {}&#34;</span>, s),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¸Œæœ›ä½ å¯¹è¿™ä¸ªç”¨æ³•å¾ˆç†Ÿæ‚‰, æˆ‘ä»¬åœ¨ä¸ä¹…å‰åˆšæåˆ°è¿‡è¿™ä¸ªç”¨æ³•.</p><p>è®©æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡æ‰“å°æ“ä½œ:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    print_user_id(<span style=color:#f92672>&amp;</span>UserID::Number(<span style=color:#ae81ff>79</span>));
</span></span><span style=display:flex><span>    print_user_id(<span style=color:#f92672>&amp;</span>UserID::Text(<span style=color:#e6db74>&#34;fh99a73gbh8&#34;</span>.into()));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>user id number <span style=color:#ae81ff>79</span>
</span></span><span style=display:flex><span>user id fh99a73gbh8
</span></span></code></pre></div><p>æˆ‘ä»¬åœ¨è¿™æ–‡ç« ä¹‹å‰çœ‹åˆ°è¿‡å¦ä¸€ä¸ªèšåˆç±»å‹, ç„¶åæˆ‘ä»¬å®ç° <code>TryInto</code>, æˆ‘ä»¬ä¼šè¿”å› <code>Result&lt;T, E></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> TryFrom<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> Drink {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Error</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;&#39;</span>static <span style=color:#66d9ef>str</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>try_from</span>(x: <span style=color:#66d9ef>i32</span>) -&gt; Result<span style=color:#f92672>&lt;</span>Self, Self::Error<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// omitted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Result</code> å€¼æ˜¯ä¸€ä¸ªæšä¸¾, å®ƒå®é™…æ˜¯è¿™æ ·å®šä¹‰çš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> Result<span style=color:#f92672>&lt;</span>T, E<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Contains the success value
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    Ok(T),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>/// Contains the error value
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>    Err(E),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è®©æˆ‘ä»¬è¿”å›çœ‹æˆ‘ä»¬çš„ <code>UserID</code> æšä¸¾:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UserID</span> {
</span></span><span style=display:flex><span>    Number(<span style=color:#66d9ef>u64</span>),
</span></span><span style=display:flex><span>    Text(String),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å®ƒçš„å¤§å°æ˜¯å¤šå°‘å‘¢? å¦‚æœæˆ‘ä»¬å°è¯•åœ¨ <code>C</code> é‡Œæ¨¡æ‹Ÿå®ç°ä¸€ä¸ª <code>Rust</code> çš„æšä¸¾, å®ƒå°†ä¼šçœ‹èµ·æ¥å¦‚ä¸‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdint.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> UserIDKind {
</span></span><span style=display:flex><span>    UserIDKind_Number,
</span></span><span style=display:flex><span>    UserIDKind_Text,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> UserID {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> UserIDKind kind;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint64_t</span> number;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>text;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>å°½ç®¡æˆ‘ä»¬åªéœ€è¦ä¸¤ä¸ªå˜ä½“, ä½†æˆ‘ä»¬éœ€è¦ä¸‰ä¸ªå±æ€§, ä»¥è®©æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬ç°åœ¨å¤„ç†çš„æ˜¯å“ªä¸€ä¸ªå˜ä½“.</p><p>ä¸¾ä¸ªä¾‹å­, åœ¨ <code>print_user_id</code>, æˆ‘ä»¬åº”è¯¥ä½¿ç”¨ <code>switch</code> æ¥å¤„ç†æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>Number</code> å˜ä½“è¿˜æ˜¯ <code>Text</code> å˜ä½“:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_user_id</span>(<span style=color:#66d9ef>struct</span> UserID<span style=color:#f92672>*</span> id) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (id<span style=color:#f92672>-&gt;</span>kind) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> UserIDKind_Number:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;user id number %lu</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, id<span style=color:#f92672>-&gt;</span>number);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> UserIDKind_Text:
</span></span><span style=display:flex><span>            printf(<span style=color:#e6db74>&#34;user id %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, id<span style=color:#f92672>-&gt;</span>text);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¹¶ä¸”å½“æˆ‘ä»¬åˆå§‹åŒ– <code>UserID</code> ç»“æ„ä½“çš„æ—¶å€™, æˆ‘ä»¬ä»…éœ€è¦åˆå§‹åŒ–æˆ‘ä»¬éœ€è¦çš„å±æ€§, å¹¶ä¸”è®¾ç½®å®ƒçš„ <code>kind</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> UserID a <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .kind <span style=color:#f92672>=</span> UserIDKind_Number,
</span></span><span style=display:flex><span>        .number <span style=color:#f92672>=</span> <span style=color:#ae81ff>79</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    print_user_id(<span style=color:#f92672>&amp;</span>a);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> UserID b <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .kind <span style=color:#f92672>=</span> UserIDKind_Text,
</span></span><span style=display:flex><span>        .text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fh99a73gbh8&#34;</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    print_user_id(<span style=color:#f92672>&amp;</span>b);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ˜¯å¯ä»¥å·¥ä½œçš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>user id number <span style=color:#ae81ff>79</span>
</span></span><span style=display:flex><span>user id fh99a73gbh8
</span></span></code></pre></div><p>ä½†è¿™å¹¶ä¸ç†æƒ³, è¿™å¹¶æ²¡æœ‰åƒ <code>Rust</code> é‚£æ ·çš„å®‰å…¨ä¿è¯, æˆ‘ä»¬æ— æ³•é˜»æ­¢ä½ åˆ›å»ºä¸€ä¸ª <code>Text</code> è€Œ <code>kind</code> æ˜¯ä¸€ä¸ª <code>Number</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> UserID woops <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .kind <span style=color:#f92672>=</span> UserIDKind_Number,
</span></span><span style=display:flex><span>        .text <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;woops&#34;</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    print_user_id(<span style=color:#f92672>&amp;</span>woops);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>user id number <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªä¸å®Œå–„çš„æŠ½è±¡ - æˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®å®ƒçš„åº•å±‚è¡¨ç¤º, å¹¶ä¸”ä»¥ä¸åˆç†çš„æ–¹å¼æ“ä½œå®ƒ.</p><p>ä¸¾ä¸ªä¾‹å­, å¦‚æœæˆ‘ä»¬çš„ <code>UserID</code> æ˜¯ä½¿ç”¨ <code>malloc</code> åœ¨å †ä¸Šåˆ†é…çš„å¹¶ä¸”ä¹Ÿæ²¡æœ‰æ¸…é›¶, é‚£ä¼šå‘ç”Ÿä»€ä¹ˆ?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> UserID <span style=color:#f92672>*</span>woops <span style=color:#f92672>=</span> malloc(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> UserID));
</span></span><span style=display:flex><span>    woops<span style=color:#f92672>-&gt;</span>kind <span style=color:#f92672>=</span> UserIDKind_Text;
</span></span><span style=display:flex><span>    woops<span style=color:#f92672>-&gt;</span>number <span style=color:#f92672>=</span> <span style=color:#ae81ff>79</span>;
</span></span><span style=display:flex><span>    print_user_id(woops);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨debugæ¨¡å¼ç¼–è¯‘ä¸‹, å®ƒä¸ä¼šå¾ˆç³Ÿç³•:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>user id <span style=color:#f92672>(</span>null<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>ç„¶è€Œåœ¨releaseæ¨¡å¼ç¼–è¯‘ä¸‹, éšç€ä¼˜åŒ–çš„æ‰“å¼€, å°†ä¼šå‘ç”Ÿå¾ˆæœ‰è¶£çš„ç°è±¡:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -O3 -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>user id <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$ clang -O3 -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>user id 
</span></span><span style=display:flex><span>$ clang -O3 -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>user id m
</span></span></code></pre></div><p>ä»å“ªé‡Œæ¥çš„? è°çŸ¥é“å‘¢. ä½†æ˜¯å®ƒæ²¡æœ‰å¯¼è‡´æ®µé”™è¯¯ - è¿™æ„å‘³ç€å®ƒä»ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†è¯»å–æ•°æ®. åœ¨ä¸€ä¸ªå¤§å‹ç¨‹åºä¸­, é‚£å¯èƒ½æ˜¯ç”¨æˆ·çš„éšç§æ•°æ®, è€Œè¿™ä¸ªæ¼æ´å°±å¯èƒ½è¢«ç”¨æ¥çªƒå–éšç§æ•°æ®.</p><p>ä¸è¿‡è¿™å¹¶ä¸æ˜¯ä¸€ç¯‡è®² <code>C</code> æœ‰å¤šå±é™©çš„æ–‡ç« ,</p><p>&mldr;emmm, è®©æˆ‘ä»¬çœ‹çœ‹è¿˜æœ‰ä»€ä¹ˆä¸å¥½çš„åœ°æ–¹.</p><p>é¦–å…ˆè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬ <code>struct UserID</code> çš„å¤§å°:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>struct UserID<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span></code></pre></div><p>24å­—èŠ‚. è¿™åªæ˜¯ä¸€ä¸ªç»“æ„ä½“, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªå·±è®¡ç®—å‡ºæ¥:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(struct UserID) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> UserID));
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;%ld + %ld + %ld = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>enum</span> UserIDKind), <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>uint64_t</span>), <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>enum</span> UserIDKind) <span style=color:#f92672>+</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>uint64_t</span>) <span style=color:#f92672>+</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>struct UserID<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> + <span style=color:#ae81ff>8</span> + 8 <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span></code></pre></div><p>Oh, woops. æˆ‘ä»¬å“ªé‡Œåšé”™äº†?</p><p>æ·¡å®š, è¿™æ˜¯å› ä¸ºåœ¨ <code>kind</code> å’Œ <code>number</code> ä¹‹é—´æœ‰ <code>padding</code>, ä»¥ä½¿æˆ‘ä»¬çš„å±æ€§æ˜¯64ä½å¯¹é½çš„(åé¢ä¼šè¯¦ç»†è¯´æ˜).</p><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ <code>UserID</code> ç»“æ„ä½“æ˜¯3*8=24ä¸ªå­—èŠ‚.</p><p>å½“å‰, æˆ‘ä»¬å¯ä»¥å‘½ä»¤ç¼–è¯‘å™¨ä¸è¦åšå¯¹é½, ç„¶ååœ¨è®¡ç®—ä¸€æ¬¡:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>__attribute__</span>((packed)) UserID {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> UserIDKind kind;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint64_t</span> number;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>text;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>struct UserID<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> + <span style=color:#ae81ff>8</span> + 8 <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span></code></pre></div><p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ <code>Rust</code> ä¸­ <code>UserID</code> æšä¸¾çš„å¤§å°:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UserID</span> {
</span></span><span style=display:flex><span>    Number(<span style=color:#66d9ef>u64</span>),
</span></span><span style=display:flex><span>    Text(String),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>UserID<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:10<span style=color:#f92672>]</span> size_of::&lt;UserID&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>
</span></span></code></pre></div><p>Oh, uh, è¿™å¤ªå¤§äº†. å¤ªå¤§äº†. æˆ‘ä¸è®¤ä¸º <code>Rust</code> çš„ <code>String</code> ç±»å‹åªæ˜¯ä¸€ä¸ªå•çº¯çš„æŒ‡å‘ç©ºå­—ç¬¦ç»“å°¾çš„æŒ‡é’ˆ(c-style). æˆ‘è®¤ä¸º <a class=link href=https://fasterthanli.me/articles/working-with-strings-in-rust target=_blank rel=noopener>it&rsquo;s a little more involved</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::{mem::size_of, os::raw::c_char};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UserID</span> {
</span></span><span style=display:flex><span>    Number(<span style=color:#66d9ef>u64</span>),
</span></span><span style=display:flex><span>    Text(<span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> c_char),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>UserID<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:10<span style=color:#f92672>]</span> size_of::&lt;UserID&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><p>Ok, è¿™çœ‹èµ·æ¥åˆç†å¤šäº†. å¹¶ä¸”æ¯” <code>C</code> ç‰ˆæœ¬è¦å°å¾ˆå¤š. è¿™é‡Œæ˜¯ä¸ºä»€ä¹ˆå‘¢?</p><p>é¦–å…ˆ, è¿™é‡Œå¿…é¡»æœ‰ä¸€ä¸ªç­‰åŒäºä¸Šé¢å†™çš„ <code>C</code> è¯­è¨€çš„ <code>kind</code> ä¸€æ ·ä½œç”¨çš„ä¸œè¥¿. åœ¨ <code>Rust</code> ä¸­, å®ƒå«åš <code>discriminant</code>(åˆ¤åˆ«ç¬¦). è¿™æ˜¯ä¸€ä¸ª &ldquo;tagged unions&rdquo; ä¸­çš„ &ldquo;tag&rdquo;.</p><p>&mldr;&mldr;æˆ‘çŒœå®ƒåº”è¯¥æ˜¯é€šè¿‡é‡å  <code>*const c_char</code> å’Œ <code>u64</code> æ¥èŠ‚çœç©ºé—´, å› ä¸ºå®ƒä»¬åªèƒ½æœ‰ä¸€ä¸ªæ˜¯æœ‰æ•ˆçš„, ä¸èƒ½åŒæ—¶å­˜åœ¨: è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç§°ä»–ä»¬ä¸º &ldquo;disjoint union&rdquo;.</p><p>æ‰€ä»¥æ€»å…±åªæœ‰16ä¸ªå­—èŠ‚.</p><p>æˆ‘ä»¬èƒ½åšç›¸åŒçš„äº‹æƒ…åœ¨ <code>C</code> é‡Œé¢å—? è¿™å½“ç„¶å¯ä»¥! <code>union</code> å…³é”®å­—å°±æ˜¯èµ·ç€ç±»ä¼¼ä½œç”¨çš„. è¿™å°±åƒæ˜¯ä¸€ä¸ªç»“æ„ä½“, åªæ˜¯æ‰€æœ‰å†…å®¹çš„å†…å­˜åœ°å€æ˜¯é‡å çš„, å®ƒçš„å¤§å°æ˜¯å®ƒå†…éƒ¨æœ€å¤§çš„é‚£ä¸€ä¸ª (æˆ–å¤šæˆ–å°‘ä¾ç„¶æ˜¯éœ€è¦è€ƒè™‘å¯¹é½çš„).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> UserID {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> UserIDKind kind;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint64_t</span> number;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>text;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(struct UserID) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> UserID));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>struct UserID<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¾—åˆ°äº†ä¸ <code>Rust</code> ç›¸åŒçš„ç»“æœ.</p><p>è¿›ä¸€æ­¥çš„, æˆ‘ä»¬å¯ä»¥æŠŠ <code>UserIDKind</code> æ”¹æˆä¸€ä¸ª <code>uint8_t</code>(åœ¨64ä½è®¡ç®—æœº, <code>clang 10</code>ä½œä¸ºç¼–è¯‘å™¨çš„æƒ…å†µä¸‹å®ƒæ˜¯4ä¸ªå­—èŠ‚):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> UserID {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> kind;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint64_t</span> number;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>text;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>struct UserID<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> 16;
</span></span></code></pre></div><p>Mhhhhå¥½åƒæ²¡å‘ç”Ÿä»€ä¹ˆå˜åŒ–&mldr;</p><p>å¯¹çš„, è®©æˆ‘ä»¬å†æ¬¡ <code>packing</code> æˆ‘ä»¬çš„ç»“æ„ä½“:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>__attribute__</span>((packed)) UserID {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> kind;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint64_t</span> number;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>text;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>struct UserID<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>
</span></span></code></pre></div><p>åªæœ‰9ä¸ªå­—èŠ‚äº†! ç°åœ¨å®ƒå‹ç¼©äº†.</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>Rust</code> ä¸­åšç±»ä¼¼çš„äº‹æƒ…å—? <code>Rust</code> é»˜è®¤æ˜¯ä»¥å±æ€§åšé€‚åº”æ€§å¯¹é½çš„, å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª <code>u8</code> and <code>u64</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Foo</span> {
</span></span><span style=display:flex><span>    bar: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    baz: <span style=color:#66d9ef>u64</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>Foo<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>&mldr;å®ƒå¢é•¿åˆ°äº†16ä¸ªå­—èŠ‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:16<span style=color:#f92672>]</span> size_of::&lt;Foo&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><p>ä½†æ˜¯, åƒ <code>C</code> ä¸€æ ·, å¦‚æœæˆ‘ä»¬å‹å¥½åœ°è¦æ±‚, <code>Rust</code> ä¹Ÿå¯ä»¥ <code>pack</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[repr(packed)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Foo</span> {
</span></span><span style=display:flex><span>    bar: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    baz: <span style=color:#66d9ef>u64</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:17<span style=color:#f92672>]</span> size_of::&lt;Foo&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>
</span></span></code></pre></div><p>ä½†æ˜¯å¦‚æœåœ¨æšä¸¾ä¸Šå‘¢?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[repr(packed)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UserID</span> {
</span></span><span style=display:flex><span>    Number(<span style=color:#66d9ef>u64</span>),
</span></span><span style=display:flex><span>    Text(<span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> c_char),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>error<span style=color:#f92672>[</span>E0517<span style=color:#f92672>]</span>: attribute should be applied to struct or union
</span></span><span style=display:flex><span> --&gt; src/main.rs:4:8
</span></span><span style=display:flex><span>  |
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> |   <span style=color:#75715e>#[repr(packed)]</span>
</span></span><span style=display:flex><span>  |          ^^^^^^
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span> | / enum UserID <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span> | |     Number<span style=color:#f92672>(</span>u64<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span> | |     Text<span style=color:#f92672>(</span>*const c_char<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span> | | <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  | |_- not a struct or union
</span></span></code></pre></div><p>æˆ‘ä»¬ä¸èƒ½ <code>pack</code>. è¿™ä¹‹å‰å·²ç» <a class=link href=https://github.com/rust-lang/rust/issues/42547 target=_blank rel=noopener>è®¨è®º</a> è¿‡äº†, ä¹Ÿæœ‰ <a class=link href=https://github.com/rust-lang/rfcs/issues/1230 target=_blank rel=noopener>è®¨è®ºå…¶å®ƒå¥‡å¼‚çš„æšä¸¾å¸ƒå±€ä¼˜åŒ–çš„æ–¹æ¡ˆ</a>, ä½†æ˜¯ç°åœ¨, è¿˜ä¸èƒ½é‚£ä¹ˆåš.</p><p>ç„¶è€Œæ˜¾ç„¶, <code>smartstring</code> å°±æ˜¯é‚£ä¹ˆåšçš„.</p><p>å½“ä¸€ä¸ª <code>SmartString</code> å­˜åœ¨å †é‡Œçš„æ—¶å€™(è¿™æ˜¯ä¸€ä¸ª <code>boxed</code> å˜ä½“), å®ƒæ˜¯24å­—èŠ‚, å°±åƒ <code>String</code> ä¸€æ ·.</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬å°è¯•åšä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ <code>smartstring</code>, ä½¿ç”¨ <code>Rust</code> çš„æšä¸¾, æˆ‘ä»¬ç”šè‡³æ— æ³•æ¥è¿‘å®ƒçš„å¤§å°:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>SmartString</span> {
</span></span><span style=display:flex><span>    Boxed(String),
</span></span><span style=display:flex><span>    Inline([<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>24</span>]),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>[<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>24</span>]<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>SmartString<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:10<span style=color:#f92672>]</span> size_of::&lt;String&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> size_of::&lt;<span style=color:#f92672>[</span>u8; 24<span style=color:#f92672>]</span>&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:12<span style=color:#f92672>]</span> size_of::&lt;SmartString&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>
</span></span></code></pre></div><p>è¿™é‡Œæœ‰ä»¶äº‹æ˜¯æˆ‘ä»¬å¯ä»¥åšçš„, æ—¢ç„¶ <code>Rust</code> ä¸å…è®¸æˆ‘ä»¬æ‰“åŒ…å®ƒçš„æšä¸¾, é‚£æˆ‘ä»¬å°±åšä¸€ä¸ªè‡ªå·±çš„æšä¸¾.</p><h2 id=å†™ä¸€ä¸ªè‡ªå·±çš„æšä¸¾>å†™ä¸€ä¸ªè‡ªå·±çš„æšä¸¾</h2><p>é¦–å…ˆ, æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ <a class=link href=https://doc.rust-lang.org/reference/items/unions.html target=_blank rel=noopener>Rust unions</a>, å› ä¸ºå®ƒåªæ”¯æŒ <code>Copy</code> å’Œé <code>Drop</code> ç±»å‹.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[repr(packed)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SmartString</span> {
</span></span><span style=display:flex><span>    discriminant: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>24</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>SmartString<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> size_of::&lt;SmartString&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>25</span>
</span></span></code></pre></div><p>çœ‹! 25ä¸ªå­—èŠ‚. è¿™æ˜¯æˆ‘ä»¬ç›®å‰æœ€å¥½çš„é¢„æƒ³äº†.</p><p>ä½†æ˜¯å®é™…ä¸Šè¿˜æ²¡åšä»»ä½•äº‹ - æˆ‘ä»¬åªæ˜¯å­˜äº†25ä¸ªå­—èŠ‚åœ¨ç»“æ„ä½“é‡Œ.</p><p>æˆ‘ä»¬éœ€è¦æƒ³å‡ºä¸€ä¸ªæ–¹æ³•æ¥ä¿å­˜æˆ‘ä»¬çš„å˜ä½“:</p><ul><li>boxed: a String</li><li>inline: some utf-8 bytes, and I guess a length?</li></ul><p>åœ¨ &ldquo;inline&rdquo; å˜ä½“æ—¶æˆ‘ä»¬ä¸èƒ½å­˜å¤§äº24ä¸ªå­—èŠ‚çš„å†…å®¹, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª <code>u8</code> æ¥è¡¨ç¤ºé•¿åº¦, å®é™…åƒä¸‹é¢æ‰€ç¤º:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Inline</span> {
</span></span><span style=display:flex><span>    len: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>23</span>],
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç„¶å, ä¸ºäº†ç¡®ä¿æˆ‘ä»¬è¿™å‡ ä¸ªç±»å‹å®é™…ä¸Šæœ‰ç€ç›¸åŒçš„å¤§å°, æˆ‘ä»¬ä½¿ç”¨ <a class=link href=https://lib.rs/crates/static_assertions target=_blank rel=noopener>static_assertions</a> crate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> static_assertions::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[repr(packed)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SmartString</span> {
</span></span><span style=display:flex><span>    discriminant: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>24</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Inline</span> {
</span></span><span style=display:flex><span>    len: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>23</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>assert_eq_size<span style=color:#f92672>!</span>(String, Inline);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>SmartString<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo check
</span></span><span style=display:flex><span>    Finished dev <span style=color:#f92672>[</span>unoptimized + debuginfo<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.00s
</span></span></code></pre></div><p>Good, è¦ç¡®ä¿è¶³å¤Ÿå‚»ç“œ, å› ä¸ºæˆ‘ä»¬å°†è¦å†™å¾ˆå¤š <code>unsafe</code> ä»£ç , æˆ‘ä»¬ç”šè‡³èƒ½æŒ‰ç…§ <code>String</code> çš„å¤§å°æ¥å®šä¹‰æˆ‘ä»¬çš„ <code>Inline</code>, è¿™ä¸ª &ldquo;crate&rdquo; å°±å¯ä»¥å¸®å¿™æ£€æŸ¥æˆ‘ä»¬çš„ <code>Inline</code> å’Œ <code>String</code> å¤§å°ç›¸åŒ.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> static_assertions::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> VARIANT_SIZE: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> std::mem::size_of::<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[repr(packed)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SmartString</span> {
</span></span><span style=display:flex><span>    discriminant: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; VARIANT_SIZE],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[allow(dead_code)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Inline</span> {
</span></span><span style=display:flex><span>    len: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    data: [<span style=color:#66d9ef>u8</span>; VARIANT_SIZE <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>],
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>assert_eq_size<span style=color:#f92672>!</span>(String, Inline);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>SmartString<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Okay, ç°åœ¨è®©æˆ‘ä»¬å®ç°æˆ‘ä»¬çš„æ‰‹åŠ¨æšä¸¾. é¦–å…ˆè®©å®ƒèƒ½å¤Ÿè¢«æ„å»º.</p><p>æˆ‘ä»¬ä»…ä½¿ç”¨äº† <code>[u8; VARIANT_SIZE]</code> æ¥ä¿ç•™ <code>VARIANT_SIZE</code> å­—èŠ‚ - å¦‚æœæˆ‘ä»¬çœŸçš„æƒ³è¦å¾€é‡Œé¢å­˜ä¸€ç‚¹ä¸œè¥¿, æˆ‘ä»¬å°†ä¼šç”¨ä¸€ä¸ª <code>*mut</code> æŒ‡é’ˆæŒ‡å‘å®ƒ, ç„¶åæŠŠå®ƒè½¬å‹ä¸ºæˆ‘ä»¬æ‰€éœ€è¦çš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new_boxed</span>(s: String) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        Self::new(<span style=color:#ae81ff>0</span>, s)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new_inline</span>() -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        Self::new(
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            Inline {
</span></span><span style=display:flex><span>                len: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                data: Default::default(),
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>new</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(discriminant: <span style=color:#66d9ef>u8</span>, data: <span style=color:#a6e22e>T</span>) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> res <span style=color:#f92672>=</span> Self {
</span></span><span style=display:flex><span>            discriminant,
</span></span><span style=display:flex><span>            data: Default::default(),
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> ptr: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> T <span style=color:#f92672>=</span> res.data.as_mut_ptr().cast();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsafe</span> { ptr.write_unaligned(data) };
</span></span><span style=display:flex><span>        res
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨æˆ‘ä»¬çš„ <code>SmartString</code> æ„å»ºè¿™ä¸¤ç§å˜ä½“:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> boxed <span style=color:#f92672>=</span> SmartString::new_boxed(<span style=color:#e6db74>&#34;This is a longer string, would not fit inline&#34;</span>.into());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> inline <span style=color:#f92672>=</span> SmartString::new_inline();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬ç›®å‰ä¹Ÿä¸èƒ½å¯¹å®ƒåšå…¶å®ƒäº‹æƒ…äº†.</p><p>è®©æˆ‘ä»¬æŠŠå®ƒå˜å¾—æœ‰ç”¨ç‚¹, ä¾‹å¦‚, ä»å®ƒè·å–ä¸€ä¸ª <code>&str</code> åˆ‡ç‰‡:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> AsRef<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>str</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>as_ref</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> self.discriminant {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> s: <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> ManuallyDrop<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> self.data.as_ptr().cast();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> tmp <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { s.read_unaligned() };
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>unsafe</span> { <span style=color:#f92672>&amp;*</span>(tmp.as_ref() <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>str</span>) }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>1</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> s: <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> Inline <span style=color:#f92672>=</span> self.data.as_ptr().cast();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>let</span> slice <span style=color:#f92672>=</span> std::slice::from_raw_parts((<span style=color:#f92672>*</span>s).data.as_ptr(), (<span style=color:#f92672>*</span>s).len <span style=color:#66d9ef>as</span> _);
</span></span><span style=display:flex><span>                    std::<span style=color:#66d9ef>str</span>::from_utf8_unchecked(slice)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> unreachable!(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿˜è®°å¾—æˆ‘ä¹‹å‰è¯´è¿‡çš„æˆ‘ä»¬åº”è¯¥å¦‚ä½•åŠªåŠ›å®¡æŸ¥ä¸å®‰å…¨ä»£ç ä»¥ç¡®ä¿ä¸ä¼šè¿åä¸å˜ä½“, åœ¨è¿™é‡Œå°±æ¯”è¾ƒé€‚ç”¨. æˆ‘ä»¬ä½¿ç”¨äº†æ›´å®‰å…¨çš„å˜ä½“, <code>unreachable</code>, ä½†æ˜¯å¦‚æœæˆ‘æƒ³å†’é™©çš„è¯, æˆ‘ä¼šè€ƒè™‘ä½¿ç”¨ <a class=link href=https://doc.rust-lang.org/std/hint/fn.unreachable_unchecked.html target=_blank rel=noopener>unreachable_unchecked</a>.</p><blockquote><p>è¯‘è€…: å®¡æŸ¥æŒ‡: åœ¨è¿™é‡Œæˆ‘ä»¬æŠŠ <code>discriminant</code> å½“ä½œä¸€ä¸ªæšä¸¾æˆ–è€…è¯´ä¸å˜ä½“ <code>match</code> äº†, å› ä¸ºå®ƒçš„å€¼åªæœ‰å¯èƒ½æ˜¯0æˆ–è€…1ä»¥è¡¨ç¤ºå†…å®¹æ˜¯ <code>inline</code> or <code>boxed</code>, ä½†æ˜¯å¯èƒ½ä¼šæœ‰å‰æ–‡åƒ <code>C</code> é‚£æ ·åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¼ é€’äº†éæ³•çš„å€¼è€Œå¯¼è‡´é”™è¯¯, æ‰€ä»¥ä½¿ç”¨ <code>unreachable!</code> å®æ¥ç¡®ä¿ä¸ä¼šæœ‰è¿™ç§æƒ…å†µå‡ºç°, åœ¨ç¼–è¯‘æœŸå°±å¯ä»¥å‹å¥½åœ°æç¤ºå¼€å‘è€…, ä»¥ä½¿ä»£ç æ›´åŠ å®‰å…¨.</p></blockquote><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª <code>AsRef</code> å®ç°, æˆ‘ä»¬å¯ä»¥æ‰“å°å‡ºå®ƒçš„å®é™…å†…å®¹äº† - è€Œä¸éœ€è¦åœ¨æ„å®é™…ä¸Šå®ƒçš„å˜ä½“æ˜¯ä»€ä¹ˆ(<code>Inline</code> or <code>Boxoed</code>).</p><p>æ–¹ä¾¿èµ·è§, æˆ‘ä»¬å®ç° <code>Display</code> å’Œ <code>Debug</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::fmt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> fmt::Display <span style=color:#66d9ef>for</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>fmt</span>(<span style=color:#f92672>&amp;</span>self, f: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> fmt::Formatter<span style=color:#f92672>&lt;&#39;</span>_<span style=color:#f92672>&gt;</span>) -&gt; <span style=color:#a6e22e>fmt</span>::Result {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> s: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> self.as_ref();
</span></span><span style=display:flex><span>        fmt::Display::fmt(s, f)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> fmt::Debug <span style=color:#66d9ef>for</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>fmt</span>(<span style=color:#f92672>&amp;</span>self, f: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> fmt::Formatter<span style=color:#f92672>&lt;&#39;</span>_<span style=color:#f92672>&gt;</span>) -&gt; <span style=color:#a6e22e>fmt</span>::Result {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> s: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span> <span style=color:#f92672>=</span> self.as_ref();
</span></span><span style=display:flex><span>        fmt::Debug::fmt(s, f)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> boxed <span style=color:#f92672>=</span> SmartString::new_boxed(<span style=color:#e6db74>&#34;This is a longer string, would not fit inline&#34;</span>.into());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> inline <span style=color:#f92672>=</span> SmartString::new_inline();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dbg!(boxed, inline);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:84<span style=color:#f92672>]</span> boxed <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;This is a longer string, would not fit inline&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:84<span style=color:#f92672>]</span> inline <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span></code></pre></div><p>æˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šäº‹æƒ…æ²¡åš - æˆ‘ä»¬ä¸èƒ½æ”¹å˜æˆ‘ä»¬çš„ <code>SmartString</code>, ä½†æ˜¯ <code>smartstring</code> æ˜¯å…è®¸çš„. æˆ‘ä»¬ä¹Ÿä¸èƒ½é™çº§æˆ‘ä»¬çš„ <code>boxed</code> ä¸º <code>inline</code>, æˆ‘ä»¬ä¹Ÿä¸èƒ½æŠŠ <code>inline</code> æå‡ä¸º <code>boxed</code> ä»¥é˜²å®ƒå­˜å¤ªå¤šä¸œè¥¿äº†.</p><p>è™½ç„¶, ä½†ç›®å‰æœ‰æ›´ç´§è¿«çš„äº‹æƒ…è¦åš.</p><p>è¯·å…è®¸æˆ‘ç¼“ç¼“é“æ¥.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> s: String <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;this is just some text&#34;</span>.into();
</span></span><span style=display:flex><span>    dbg!(s);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo build --quiet --release <span style=color:#f92672>&amp;&amp;</span> valgrind --tool<span style=color:#f92672>=</span>memcheck ./target/release/enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> Memcheck, a memory error detector
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> 2002-2017, and GNU GPL<span style=color:#ae81ff>\&#39;</span>d, by Julian Seward et al.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> Using Valgrind-3.16.1 and LibVEX; rerun with -h <span style=color:#66d9ef>for</span> copyright info
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> Command: ./target/release/enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:82<span style=color:#f92672>]</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;this is just some text&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> HEAP SUMMARY:
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span>     in use at exit: <span style=color:#ae81ff>0</span> bytes in <span style=color:#ae81ff>0</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span>   total heap usage: <span style=color:#ae81ff>15</span> allocs, <span style=color:#ae81ff>15</span> frees, 2,335 bytes allocated
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> All heap blocks were freed -- no leaks are possible
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> For lists of detected and suppressed errors, rerun with: -s
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173592<span style=color:#f92672>==</span> ERROR SUMMARY: <span style=color:#ae81ff>0</span> errors from <span style=color:#ae81ff>0</span> contexts <span style=color:#f92672>(</span>suppressed: <span style=color:#ae81ff>0</span> from 0<span style=color:#f92672>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> s: <span style=color:#a6e22e>SmartString</span> <span style=color:#f92672>=</span> SmartString::new_boxed(<span style=color:#e6db74>&#34;this is just some text&#34;</span>.into());
</span></span><span style=display:flex><span>    dbg!(s);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo build --quiet --release <span style=color:#f92672>&amp;&amp;</span> valgrind --tool<span style=color:#f92672>=</span>memcheck ./target/release/enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> Memcheck, a memory error detector
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> 2002-2017, and GNU GPL<span style=color:#ae81ff>\&#39;</span>d, by Julian Seward et al.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> Using Valgrind-3.16.1 and LibVEX; rerun with -h <span style=color:#66d9ef>for</span> copyright info
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> Command: ./target/release/enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:82<span style=color:#f92672>]</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;this is just some text&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> HEAP SUMMARY:
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span>     in use at exit: <span style=color:#ae81ff>22</span> bytes in <span style=color:#ae81ff>1</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span>   total heap usage: <span style=color:#ae81ff>15</span> allocs, <span style=color:#ae81ff>14</span> frees, 2,335 bytes allocated
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> LEAK SUMMARY:
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span>    definitely lost: <span style=color:#ae81ff>22</span> bytes in <span style=color:#ae81ff>1</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span>    indirectly lost: <span style=color:#ae81ff>0</span> bytes in <span style=color:#ae81ff>0</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span>      possibly lost: <span style=color:#ae81ff>0</span> bytes in <span style=color:#ae81ff>0</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span>    still reachable: <span style=color:#ae81ff>0</span> bytes in <span style=color:#ae81ff>0</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span>         suppressed: <span style=color:#ae81ff>0</span> bytes in <span style=color:#ae81ff>0</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> Rerun with --leak-check<span style=color:#f92672>=</span>full to see details of leaked memory
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> For lists of detected and suppressed errors, rerun with: -s
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>173779<span style=color:#f92672>==</span> ERROR SUMMARY: <span style=color:#ae81ff>0</span> errors from <span style=color:#ae81ff>0</span> contexts <span style=color:#f92672>(</span>suppressed: <span style=color:#ae81ff>0</span> from 0<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å‘ç”Ÿäº†å†…å­˜æ³„æ¼!</p><p><code>String</code> åªæ˜¯ä¸€ä¸ªå•çº¯çš„ç»“æ„ä½“, ä½†å®ƒåœ¨å †ä¸­æœ‰è‡ªå·±çš„å†…å­˜åˆ†é…. åœ¨æˆ‘ä»¬çš„ <code>SmartString::new_boxed</code> ä¸­, æˆ‘ä»¬æ‹¿äº† <code>String</code> çš„æ‰€æœ‰æƒ, å¹¶ä¸”å®ƒæœ‰ç€åœ¨å †ä¸­ç›¸å…³è”çš„å†…å­˜æˆ‘ä»¬ä¸æ›¾é‡Šæ”¾.</p><p>ç¼–è¯‘å™¨ä¸çŸ¥é“é‡Šæ”¾æˆ‘ä»¬ä¿å­˜åœ¨ <code>SmartString</code> ä»¥ <code>boxed</code> å½¢å¼å­˜æ”¾çš„ <code>String</code>, å› ä¸ºå®ƒä¸çŸ¥é“æˆ‘ä»¬æ‹¿çš„æ˜¯ä»€ä¹ˆç±»å‹ - å®ƒåªçŸ¥é“æˆ‘ä»¬ç”¨äº†24ä¸ªå­—èŠ‚, è¿™24ä¸ªå­—èŠ‚å¯èƒ½æ”¾ç€ä»»ä½•ä¸œè¥¿.</p><p>å¦‚æœæˆ‘ä»¬çŸ¥é“è¿™ä¸ªç±»å‹, äº‹å®ä¸Šç¡®å®, åªæ˜¯ä¸ª <code>String</code>, å¹¶ä¸”å®ƒä»¬éœ€è¦è¢« <code>dropped</code>, æˆ‘ä»¬éœ€è¦å‘Šè¯‰ç¼–è¯‘å™¨.</p><p>ä¸‹é¢æ˜¯æˆ‘ä»¬åš <code>Drop</code> çš„ç¬¬ä¸€æ¬¡ç—›è‹¦ç»å†:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> Drop <span style=color:#66d9ef>for</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>drop</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> self.discriminant {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> s: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> String <span style=color:#f92672>=</span> self.data.as_mut_ptr().cast();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> b: String <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { <span style=color:#f92672>*</span>s };
</span></span><span style=display:flex><span>                drop(b);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>1</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> unreachable!(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>error<span style=color:#f92672>[</span>E0507<span style=color:#f92672>]</span>: cannot move out of <span style=color:#e6db74>`</span>*s<span style=color:#e6db74>`</span> which is behind a raw pointer
</span></span><span style=display:flex><span>  --&gt; src/main.rs:46:42
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span><span style=color:#ae81ff>46</span> |                 let b: String <span style=color:#f92672>=</span> unsafe <span style=color:#f92672>{</span> *s <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span>   |                                          ^^
</span></span><span style=display:flex><span>   |                                          |
</span></span><span style=display:flex><span>   |                                          move occurs because <span style=color:#e6db74>`</span>*s<span style=color:#e6db74>`</span> has type <span style=color:#e6db74>`</span>std::string::String<span style=color:#e6db74>`</span>, which does not implement the <span style=color:#e6db74>`</span>Copy<span style=color:#e6db74>`</span> trait
</span></span><span style=display:flex><span>   |                                          help: consider borrowing here: <span style=color:#e6db74>`</span>&amp;*s<span style=color:#e6db74>`</span>
</span></span></code></pre></div><p>Woops, è¿™ä¸èƒ½å·¥ä½œ, æˆ‘ä»¬ä¸èƒ½ä»ä¸€ä¸ª <code>raw pointer</code> <code>move</code> å› ä¸º <code>String</code> ä¸æ˜¯ <code>Copy</code>.</p><p>æˆ‘ä»¬èƒ½åšäº›ä»€ä¹ˆ? æˆ‘ä»¬èƒ½æŠŠå®ƒ <code>Box</code> èµ·æ¥ä¹ˆ, <code>Box</code> æœ‰ä¸€ä¸ª <code>from_raw</code> æ–¹æ³•, è¿™å¬èµ·æ¥ä¸é”™:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> Drop <span style=color:#66d9ef>for</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>drop</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> self.discriminant {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> s: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> String <span style=color:#f92672>=</span> self.data.as_mut_ptr().cast();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> b <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { Box::from_raw(s) };
</span></span><span style=display:flex><span>                drop(b);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>1</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> unreachable!(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:117<span style=color:#f92672>]</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;this is just some text&#34;</span>
</span></span><span style=display:flex><span>free<span style=color:#f92672>()</span>: invalid pointer
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>    <span style=color:#ae81ff>179297</span> abort <span style=color:#f92672>(</span>core dumped<span style=color:#f92672>)</span>  cargo run -q
</span></span></code></pre></div><p>Uh, oh.</p><p>è®©æˆ‘ä»¬ç”¨æˆ‘ä»¬å‹å¥½çš„ <code>Valgrind</code> æ£€æŸ¥ä¸€ä¸‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>$</span> cargo build <span style=color:#f92672>--</span>quiet <span style=color:#f92672>--</span>release <span style=color:#f92672>&amp;&amp;</span> valgrind <span style=color:#f92672>--</span>tool<span style=color:#f92672>=</span>memcheck .<span style=color:#f92672>/</span>target<span style=color:#f92672>/</span>release<span style=color:#f92672>/</span>enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> Memcheck, a memory error detector
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> Copyright (C) <span style=color:#ae81ff>2002</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2017</span>, and GNU GPL<span style=color:#f92672>&#39;</span><span style=color:#a6e22e>d</span>, by Julian Seward et al.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> Using Valgrind<span style=color:#f92672>-</span><span style=color:#ae81ff>3.16.1</span> and LibVEX; rerun with <span style=color:#f92672>-</span>h <span style=color:#66d9ef>for</span> copyright info
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> Command: .<span style=color:#f92672>/</span>target<span style=color:#f92672>/</span>release<span style=color:#f92672>/</span>enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span>[src<span style=color:#f92672>/</span>main.rs:<span style=color:#ae81ff>117</span>] s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;this is just some text&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> Invalid free() <span style=color:#f92672>/</span> delete <span style=color:#f92672>/</span> delete[] <span style=color:#f92672>/</span> realloc()
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    at <span style=color:#ae81ff>0x483B9AB</span>: <span style=color:#a6e22e>free</span> (vg_replace_malloc.c:<span style=color:#ae81ff>538</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x10D501</span>: <span style=color:#a6e22e>enumpeek</span>::main (<span style=color:#66d9ef>in</span> <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>amos<span style=color:#f92672>/</span>ftl<span style=color:#f92672>/</span>enumpeek<span style=color:#f92672>/</span>target<span style=color:#f92672>/</span>release<span style=color:#f92672>/</span>enumpeek)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x10D8E2</span>: <span style=color:#a6e22e>std</span>::rt::lang_start::{{closure}} (<span style=color:#66d9ef>in</span> <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>amos<span style=color:#f92672>/</span>ftl<span style=color:#f92672>/</span>enumpeek<span style=color:#f92672>/</span>target<span style=color:#f92672>/</span>release<span style=color:#f92672>/</span>enumpeek)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x1163F7</span>: {{closure}} (rt.rs:<span style=color:#ae81ff>52</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x1163F7</span>: <span style=color:#a6e22e>do_call</span><span style=color:#f92672>&lt;</span>closure<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span> (panicking.rs:<span style=color:#ae81ff>297</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x1163F7</span>: <span style=color:#a6e22e>try</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>i32</span>,closure<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span><span style=color:#f92672>&gt;</span> (panicking.rs:<span style=color:#ae81ff>274</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x1163F7</span>: <span style=color:#a6e22e>catch_unwind</span><span style=color:#f92672>&lt;</span>closure<span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span> (panic.rs:<span style=color:#ae81ff>394</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x1163F7</span>: <span style=color:#a6e22e>std</span>::rt::lang_start_internal (rt.rs:<span style=color:#ae81ff>51</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>    by <span style=color:#ae81ff>0x10D561</span>: <span style=color:#a6e22e>main</span> (<span style=color:#66d9ef>in</span> <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>amos<span style=color:#f92672>/</span>ftl<span style=color:#f92672>/</span>enumpeek<span style=color:#f92672>/</span>target<span style=color:#f92672>/</span>release<span style=color:#f92672>/</span>enumpeek)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>  Address <span style=color:#ae81ff>0x1ffefff561</span> is on thread <span style=color:#ae81ff>1</span><span style=color:#f92672>&#39;</span><span style=color:#a6e22e>s</span> stack
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>  <span style=color:#66d9ef>in</span> frame #<span style=color:#ae81ff>1</span>, created by enumpeek::main (<span style=color:#f92672>???</span>:)
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> HEAP SUMMARY:
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>     <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>use</span> at exit: <span style=color:#ae81ff>0</span> bytes <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>0</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span>   total heap usage: <span style=color:#ae81ff>15</span> allocs, <span style=color:#ae81ff>16</span> frees, <span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>335</span> bytes allocated
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> All heap blocks were freed <span style=color:#f92672>--</span> no leaks are possible
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> For lists of detected and suppressed errors, rerun with: <span style=color:#f92672>-</span>s
</span></span><span style=display:flex><span><span style=color:#f92672>==</span><span style=color:#ae81ff>179648</span><span style=color:#f92672>==</span> ERROR SUMMARY: <span style=color:#ae81ff>1</span> errors from <span style=color:#ae81ff>1</span> contexts (suppressed: <span style=color:#ae81ff>0</span> from <span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><p>é—®é¢˜çœ‹èµ·æ¥åƒæ˜¯å®ƒåœ¨è¯•å›¾é‡Šæ”¾ <code>String</code> å°±åƒå®ƒåˆ†é…åœ¨å †ä¸Šä¸€æ ·, ç„¶è€Œå¹¶æ²¡æœ‰! å®é™…ä¸Šæ˜¯ <code>String</code> ä¸­çš„æ•°æ®åˆ†é…åœ¨å †ä¸Š, è€Œä¸æ˜¯ <code>String</code> æœ¬èº«.</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªçœ‹èµ·æ¥ç”Ÿæ•ˆçš„æ–¹æ³•:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> Drop <span style=color:#66d9ef>for</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>drop</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> self.discriminant {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> s: <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> String <span style=color:#f92672>=</span> self.data.as_mut_ptr().cast();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> s: String <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { std::ptr::read_unaligned(s) };
</span></span><span style=display:flex><span>                drop(s);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>1</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> unreachable!(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥:</p><ul><li>ä½¿ç”¨æ³›å‹å‡½æ•°æ¥å‡å°‘é‡å¤ä»£ç .</li><li>çœç•¥æ‰ <code>drop</code>, åœ¨ <code>std::ptr::read_unaligned</code> ç¦»å¼€ä½œç”¨åŸŸåè‡ªåŠ¨è°ƒç”¨.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>drop_variant</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span>self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsafe</span> { std::ptr::read_unaligned(self.data.as_ptr().cast::<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>()) };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Drop <span style=color:#66d9ef>for</span> SmartString {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>drop</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> self.discriminant {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>unsafe</span> { self.drop_variant::<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>() },
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>1</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>unsafe</span> { self.drop_variant::<span style=color:#f92672>&lt;</span>Inline<span style=color:#f92672>&gt;</span>() },
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> unreachable!(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo build --quiet --release <span style=color:#f92672>&amp;&amp;</span> valgrind --tool<span style=color:#f92672>=</span>memcheck ./target/release/enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> Memcheck, a memory error detector
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> 2002-2017, and GNU GPL<span style=color:#ae81ff>\&#39;</span>d, by Julian Seward et al.
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> Using Valgrind-3.16.1 and LibVEX; rerun with -h <span style=color:#66d9ef>for</span> copyright info
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> Command: ./target/release/enumpeek
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:99<span style=color:#f92672>]</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;this is just some text&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> HEAP SUMMARY:
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span>     in use at exit: <span style=color:#ae81ff>0</span> bytes in <span style=color:#ae81ff>0</span> blocks
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span>   total heap usage: <span style=color:#ae81ff>15</span> allocs, <span style=color:#ae81ff>15</span> frees, 2,335 bytes allocated
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> All heap blocks were freed -- no leaks are possible
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> For lists of detected and suppressed errors, rerun with: -s
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>181085<span style=color:#f92672>==</span> ERROR SUMMARY: <span style=color:#ae81ff>0</span> errors from <span style=color:#ae81ff>0</span> contexts <span style=color:#f92672>(</span>suppressed: <span style=color:#ae81ff>0</span> from 0<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>å®Œç¾, ä½†æ˜¯è¿™å®Œå…¨æ­£ç¡®äº†å—? æˆ‘ä¸çŸ¥é“, åœ¨è®©ä¸€å †äººæµ‹è¯•çœ‹çœ‹ä¹‹å‰æˆ‘æ˜¯ä¸ä¼šæŠŠä»£ç ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒä¸­çš„. ä½†æ˜¯è‡³å°‘åœ¨æˆ‘ä»¬çš„ <code>case</code> ä¸­, å®ƒå·²ç»æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼äº†.</p><p>è¿™æ€»å½’æ˜¯å¥½çš„.</p><p>æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„ç»“æ„ä½“ä¸­èŠ±ä¸Šæ•´å¤©æ—¶é—´éƒ½åœ¨è¿™é‡æ–°å®ç° <code>smartstring</code> é‡Œé¢çš„åŠŸèƒ½, ä½†æ˜¯æœ‰ä¸ªç‚¹éœ€è¦è®°ä½, æˆ‘ä»¬çš„ç‰ˆæœ¬æ¯” <code>smartstring</code> å¤§äº†è¶³è¶³ä¸€ä¸ªå­—èŠ‚.</p><p>å°±åƒ <code>smallvec::SmallVec</code> ç±»å‹æ¯” <code>Vec</code> å¤§ä¸€æ ·.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo add smallvec
</span></span><span style=display:flex><span>      Adding smallvec v1.4.2 to dependencies
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::mem::size_of;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> smallvec::SmallVec;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    dbg!(size_of::<span style=color:#f92672>&lt;</span>Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;&gt;</span>(), size_of::<span style=color:#f92672>&lt;</span>SmallVec<span style=color:#f92672>&lt;</span>[<span style=color:#66d9ef>u8</span>; <span style=color:#ae81ff>1</span>]<span style=color:#f92672>&gt;&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:100<span style=color:#f92672>]</span> size_of::&lt;Vec&lt;u8&gt;&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:100<span style=color:#f92672>]</span> size_of::&lt;SmallVec&lt;<span style=color:#f92672>[</span>u8; 1<span style=color:#f92672>]</span>&gt;&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>
</span></span></code></pre></div><p>å› æ­¤, å¸Œæœ›åˆ°ç›®å‰ä¸ºæ­¢æœ¬æ–‡è®²è¿°çš„è¶³è¶³44åˆ†é’Ÿçš„æ—¶é—´é‡Œä½ å·²ç» <strong>å®Œå…¨</strong> æ˜ç™½äº†ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜(è¯·å›å¿†ä¸‹å¼€ç¯‡æ‰€æåˆ°çš„é—®é¢˜).</p><p>å®ƒçš„ç¥ç§˜ä¸åœ¨äº <code>SmallVec&lt;[u8; 1]></code> æ¯” <code>Vec&lt;u8></code> å¤§8ä¸ªå­—èŠ‚, å› ä¸º <code>SmallVec</code> åªæ˜¯ä¸€ä¸ªæšä¸¾, å®ƒçš„åˆ¤å®šå¼åªéœ€è¦è€ƒè™‘ä¸¤ä¸ªå˜ä½“, ä½†æ˜¯å› ä¸º <code>Rust</code> éœ€è¦é¢å¤–çš„ç©ºé—´æ¥ä¿è¯å¯¹é½, æ‰€ä»¥å¤šç”¨äº†æ•´æ•´8ä¸ªå­—èŠ‚.</p><p>å®ƒçš„ç¥ç§˜åœ¨äº, <code>SmartString</code> æ˜¯æ€ä¹ˆåšåˆ°åªæœ‰24ä¸ªå­—èŠ‚çš„.</p><p>ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬éœ€è¦æ›´æ·±å…¥çš„è§‚å¯ŸæŒ‡é’ˆ.</p><h2 id=ä»”ç»†çœ‹çœ‹æŒ‡é’ˆ>ä»”ç»†çœ‹çœ‹æŒ‡é’ˆ</h2><p>So, ä»€ä¹ˆæ˜¯æŒ‡é’ˆ? åªæ˜¯ä¸€ä¸²æ•°å­—? å®ƒå‘Šè¯‰äº†ä½ æœ‰äº›ä¸œè¥¿åœ¨å†…å­˜çš„å“ªä¸ªåœ°æ–¹.</p><p>ä¸¾ä¸ªä¾‹å­, å¦‚æœæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªæœ¬åœ°å˜é‡ <code>x</code>, <code>i32</code>, å®ƒå¯èƒ½ç›´ç«‹åœ¨æ ˆä¸Š:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// this is a signed 32-bit integer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> x <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// this is a reference to a signed 32-bit integer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> x_ref <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>x;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// this is a pointer to a signed 32-bit integer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> x_ptr <span style=color:#f92672>=</span> x_ref <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dbg!(x_ptr);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:105<span style=color:#f92672>]</span> x_ptr <span style=color:#f92672>=</span> 0x00007fff10be39ec
</span></span></code></pre></div><p>å½“ç„¶, ä¸€ä¸ªæœ¬åœ°å˜é‡ä¹Ÿå¯èƒ½åœ¨å¯„å­˜å™¨ä¸­. ä½†è¿™åœ¨è¿™é‡Œæ— å…³ç´§è¦. ä¸€æ—¦æˆ‘ä»¬è·å–äº†æŸä¸ªå¯¹è±¡çš„åœ°å€, å®ƒå°±éœ€è¦æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´çš„æŸä¸ªåœ°æ–¹, è€Œåœ¨å¯„å­˜å™¨ä¸­çš„åˆ™ä¸éœ€è¦, ä¸ºäº†æ–¹ä¾¿è§£é‡Š, æˆ‘ä»¬ç°åœ¨å‡è£…å¯„å­˜å™¨ä¸å­˜åœ¨.</p><p>So, æ•°å­—æ˜¯ä¸ºäº†å‘Šè¯‰ä½ æŸäº›ä¸œè¥¿åœ¨å†…å­˜ä¸­çš„ä½ç½®. è¿™å°±åƒæ˜¯åœ°å€, å°±è·Ÿå›½å®¶æœ‰å®é™…ä½ç½®çš„åœ°å€ä¸€æ ·, åªæ˜¯å¤šäº†äº›é—´æ¥æ€§.</p><p>ä¸€ä¸ªå¯¹é½çš„æŒ‡é’ˆæ˜¯ä¸€ä¸ªå…¶å€¼(åœ°å€)æ˜¯æ•°æ®å¤§å°çš„å€æ•°çš„æŒ‡é’ˆ. å½“æ•°æ®æ˜¯è‡ªç„¶å¯¹é½çš„æ—¶å€™å¯¹ CPUs æ¥è¯´å¾ˆæ–¹ä¾¿.</p><p>è®©æˆ‘ä»¬çœ‹ä¸€äº›ä¾‹å­.</p><p>æˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­å¯»å€çš„çš„æœ€å°å•å…ƒæ˜¯å­—èŠ‚. ä¸€ä¸ªæŒ‡å‘å­—èŠ‚çš„æŒ‡é’ˆæ€»æ˜¯å¯¹é½çš„, å› ä¸ºæŒ‡é’ˆç”¨å­—èŠ‚æ¥è®¡æ•°, æ¢å¥è¯è¯´, ä¸€ä¸ª <code>u8</code> çš„å¯¹é½å•ä½å°±æ˜¯1.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> arr <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span><span style=color:#66d9ef>u8</span>, <span style=color:#ae81ff>2</span><span style=color:#66d9ef>u8</span>, <span style=color:#ae81ff>3</span><span style=color:#66d9ef>u8</span>, <span style=color:#ae81ff>4</span><span style=color:#66d9ef>u8</span>];
</span></span><span style=display:flex><span>    dbg!(
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>arr[<span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>arr[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>arr[<span style=color:#ae81ff>2</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>arr[<span style=color:#ae81ff>3</span>] <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> _,
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:106<span style=color:#f92672>]</span> &amp;arr<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> as *const _ <span style=color:#f92672>=</span> 0x00007ffd6474abdc
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:106<span style=color:#f92672>]</span> &amp;arr<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> as *const _ <span style=color:#f92672>=</span> 0x00007ffd6474abdd
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:106<span style=color:#f92672>]</span> &amp;arr<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> as *const _ <span style=color:#f92672>=</span> 0x00007ffd6474abde
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:106<span style=color:#f92672>]</span> &amp;arr<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> as *const _ <span style=color:#f92672>=</span> 0x00007ffd6474abdf
</span></span></code></pre></div><p>å¦‚æœè®¨è®ºçš„æ˜¯æŒ‡å‘ <code>u16</code> çš„æŒ‡é’ˆ, é‚£ä¹ˆå®ƒçš„å¯¹é½å•ä½æ˜¯2.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>fn main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    let arr <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>1u16, 2u16, 3u16, 4u16<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>    fn inspect&lt;T&gt;<span style=color:#f92672>(</span>t: *const T<span style=color:#f92672>)</span> -&gt; <span style=color:#f92672>(</span>*const T, bool<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>(</span>t, t as usize % 2 <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dbg!<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>        inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>        inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>        inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:110<span style=color:#f92672>]</span> inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffd81bf5918,
</span></span><span style=display:flex><span>    true,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:110<span style=color:#f92672>]</span> inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffd81bf591a,
</span></span><span style=display:flex><span>    true,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:110<span style=color:#f92672>]</span> inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffd81bf591c,
</span></span><span style=display:flex><span>    true,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:110<span style=color:#f92672>]</span> inspect<span style=color:#f92672>(</span>&amp;arr<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> as *const _<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    0x00007ffd81bf591e,
</span></span><span style=display:flex><span>    true,
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>åŒç†, å¯¹äº <code>u32</code> æ˜¯4, <code>u64</code> æ˜¯8.</p><p>ä¸‹é¢æœ‰ä¸€ä¸ªæ­£ç¡®å¯¹é½çš„ä¾‹å­:</p><p>åº•éƒ¨çš„å°æ–¹å—è¡¨ç¤ºå¦‚æœæˆ‘ä»¬æƒ³è¦å­˜è¯¥ç±»å‹, å¯ä»¥æŠŠå®ƒæ”¾åœ¨é‚£é‡Œ.</p><p>é¡¶éƒ¨éƒ¨åˆ†è¡¨ç¤ºå®é™…çš„å†…å­˜å¸ƒå±€, ä¸¾ä¸ªä¾‹å­, ä¸€ä¸ªç»“æ„ä½“:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdint.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stddef.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> S {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint16_t</span> c;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> d;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;sizeof(S) = %ld</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> S));
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;offsetof(struct S, a) = %zu</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, offsetof(<span style=color:#66d9ef>struct</span> S, a));
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;offsetof(struct S, b) = %zu</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, offsetof(<span style=color:#66d9ef>struct</span> S, b));
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;offsetof(struct S, c) = %zu</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, offsetof(<span style=color:#66d9ef>struct</span> S, c));
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;offsetof(struct S, d) = %zu</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, offsetof(<span style=color:#66d9ef>struct</span> S, d));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, a<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, b<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, c<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, d<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span></code></pre></div><p>åœ¨è¿™é‡Œ, ä¸€åˆ‡é¡ºåˆ©.</p><p>æˆ‘ä»¬ç”¨å¦ä¸€ä¸ªå¸ƒå±€ä»£æ›¿çœ‹çœ‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> S {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> a;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint16_t</span> b;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> c;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> d;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ clang -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>sizeof<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, a<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, b<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, c<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>offsetof<span style=color:#f92672>(</span>struct S, d<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span></code></pre></div><p>ä¸ºäº†ç»´æŒå¯¹é½, ç¼–è¯‘å™¨æ’å…¥äº†åºŸæ–™:</p><p>&ldquo;Padding&rdquo; ä¸ç»å¯¹æ˜¯ç½®é›¶ - å®ƒåªæ˜¯æ²¡æœ‰ä½¿ç”¨çš„ç©ºé—´. å³ä½¿å®ƒåˆå§‹åŒ–ç½®é›¶äº†, ä¹Ÿä¸èƒ½ä¿è¯å®ƒä¼šåœ¨ä½ åˆ†é…æˆå‘˜çš„æ—¶å€™ç»´æŒ0.</p><p>ç»å¸¸ä½¿ç”¨è¯¥ç»“æ„ä½“å¯èƒ½ä¼šæ··æ·†å€¼å’Œå¡«å……çš„ <code>padding</code>, å› æ­¤ä¸€ä¸ªå¥½çš„ <code>old block memory comparison</code> (memcmp) ä¸èƒ½å¤Ÿæµ‹è¯•ä¸¤ä¸ªç»“æ„ä½“æ˜¯å¦å®Œå…¨ç›¸ç­‰.</p><blockquote><p>åŸæ–‡: Regular usage of the struct might mess with the values in the padding, and so a good old block memory comparison (memcmp) would not be enough to test two structs for equality.</p></blockquote><blockquote><p>è¯‘è€…: è¿™é‡Œæ²¡æ‡‚ä½œè€…æƒ³è¯´ä»€ä¹ˆ, æœ‰äººæ¸…æ¥šçš„è¯å¯ä»¥æä¸ªissueç»™æˆ‘.</p></blockquote><p>æˆ‘ä»¬åœ¨ <code>Rust</code> ä¸­å®šä¹‰ä¸€ä¸ªç›¸åŒå¸ƒå±€çš„ç»“æ„ä½“ä¼šå‘ç”Ÿä»€ä¹ˆ?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>S</span> {
</span></span><span style=display:flex><span>        a: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        b: <span style=color:#66d9ef>u16</span>,
</span></span><span style=display:flex><span>        c: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        d: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dbg!(std::mem::size_of::<span style=color:#f92672>&lt;</span>S<span style=color:#f92672>&gt;</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:112<span style=color:#f92672>]</span> std::mem::size_of::&lt;S&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span></code></pre></div><p>ä¸ºä»€ä¹ˆåªæœ‰8ä¸ªå­—èŠ‚? å‘ç”Ÿäº†ä»€ä¹ˆ? è®©æˆ‘ä»¬æ¥å€ŸåŠ©å·¥å…·çœ‹çœ‹å®ƒçš„å¸ƒå±€:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo add memoffset
</span></span><span style=display:flex><span>      Adding memoffset v0.5.5 to dependencies
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>S</span> {
</span></span><span style=display:flex><span>        a: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        b: <span style=color:#66d9ef>u16</span>,
</span></span><span style=display:flex><span>        c: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        d: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> memoffset::offset_of;
</span></span><span style=display:flex><span>    dbg!(
</span></span><span style=display:flex><span>        std::mem::size_of::<span style=color:#f92672>&lt;</span>S<span style=color:#f92672>&gt;</span>(),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, a),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, b),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, c),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, d)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:113<span style=color:#f92672>]</span> std::mem::size_of::&lt;S&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:113<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, a<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:113<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, b<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:113<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, c<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:113<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, d<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çš„æˆå‘˜è¢«é‡æ–°æ’åºäº†!</p><p>æˆ‘ä»¬å¯ä»¥è®© <code>Rust compiler</code> ä¸è¦é‡æ’åºå°±åƒ <code>C</code> ä¸€æ ·é€šè¿‡ <code>repr(C)</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[repr(C)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>S</span> {
</span></span><span style=display:flex><span>        a: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        b: <span style=color:#66d9ef>u16</span>,
</span></span><span style=display:flex><span>        c: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        d: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> memoffset::offset_of;
</span></span><span style=display:flex><span>    dbg!(
</span></span><span style=display:flex><span>        std::mem::size_of::<span style=color:#f92672>&lt;</span>S<span style=color:#f92672>&gt;</span>(),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, a),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, b),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, c),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, d)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> std::mem::size_of::&lt;S&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, a<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, b<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, c<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, d<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span></code></pre></div><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†å’Œ <code>C</code> ä¸€æ ·çš„å¸ƒå±€äº†, ä¹Ÿæœ‰ç€ç›¸åŒçš„å¡«å…….</p><p>æˆ–è€…ä¹Ÿå¯ä»¥è®©ç¼–è¯‘å™¨æ—¢ä¸è¦é‡æ–°æ’åºä¹Ÿä¸è¦å¡«å……ä»¥å®Œå…¨å¿½ç•¥å¯¹é½:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[repr(C, packed)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>S</span> {
</span></span><span style=display:flex><span>        a: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        b: <span style=color:#66d9ef>u16</span>,
</span></span><span style=display:flex><span>        c: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        d: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>use</span> memoffset::offset_of;
</span></span><span style=display:flex><span>    dbg!(
</span></span><span style=display:flex><span>        std::mem::size_of::<span style=color:#f92672>&lt;</span>S<span style=color:#f92672>&gt;</span>(),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, a),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, b),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, c),
</span></span><span style=display:flex><span>        offset_of<span style=color:#f92672>!</span>(S, d)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç°åœ¨, <code>S.b</code> ä¸å†å¾ˆå¥½åœ°å¯¹é½äº†.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> std::mem::size_of::&lt;S&gt;<span style=color:#f92672>()</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, a<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, b<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, c<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:11<span style=color:#f92672>]</span> offset_of!<span style=color:#f92672>(</span>S, d<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span></code></pre></div><p>å‡å¦‚æˆ‘ä»¬å°è¯•è·å–ä¸€ä¸ªå¼•ç”¨, <code>Rust</code> ä¼šè­¦å‘Šæˆ‘ä»¬(å½“å‰åªæ˜¯ <code>warn</code>, ä»¥åå¯èƒ½ä¼šå˜æˆä¸€ä¸ª <code>error</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[repr(C, packed)]</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[derive(Default)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>S</span> {
</span></span><span style=display:flex><span>        a: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        b: <span style=color:#66d9ef>u16</span>,
</span></span><span style=display:flex><span>        c: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        d: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> s: <span style=color:#a6e22e>S</span> <span style=color:#f92672>=</span> Default::default();
</span></span><span style=display:flex><span>    dbg!(<span style=color:#f92672>&amp;</span>s.b);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>warning: borrow of packed field is unsafe and requires unsafe <span style=color:#66d9ef>function</span> or block <span style=color:#f92672>(</span>error E0133<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  --&gt; src/main.rs:12:10
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span> |     dbg!<span style=color:#f92672>(</span>&amp;s.b<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>   |          ^^^^
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span>   <span style=color:#f92672>=</span> note: <span style=color:#e6db74>`</span><span style=color:#75715e>#[warn(safe_packed_borrows)]` on by default</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>=</span> warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!
</span></span><span style=display:flex><span>   <span style=color:#f92672>=</span> note: <span style=color:#66d9ef>for</span> more information, see issue <span style=color:#75715e>#46043 &lt;https://github.com/rust-lang/rust/issues/46043&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>=</span> note: fields of packed structs might be misaligned: dereferencing a misaligned pointer or even just creating a misaligned reference is undefined behavior
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>warning: <span style=color:#ae81ff>1</span> warning emitted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>src/main.rs:12<span style=color:#f92672>]</span> &amp;s.b <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>è¿„ä»Š&mldr; æ‰€æœ‰çš„äº‹æƒ…åœ¨æˆ‘ <code>2018 i7</code> å¤„ç†å™¨ä¸Šå·¥ä½œå¾—å¾ˆå¥½.</p><p>æˆ‘ä»¬å¯ä»¥æ”¹å˜å®ƒä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[repr(C, packed)]</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[derive(Default)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>S</span> {
</span></span><span style=display:flex><span>        a: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        b: <span style=color:#66d9ef>u16</span>,
</span></span><span style=display:flex><span>        c: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>        d: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> s: <span style=color:#a6e22e>S</span> <span style=color:#f92672>=</span> Default::default();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        s.b <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x123</span>;
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;{:#x}&#34;</span>, s.b);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>0x123
</span></span></code></pre></div><p>è¿™å¹¶ä¸æ˜¯è·å¾—æœªå¯¹é½æŒ‡é’ˆçš„å”¯ä¸€æ–¹æ³•, ä½¿ç”¨æŒ‡é’ˆç±»å‹è½¬æ¢æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠä¸¤ä¸ª <code>u8</code> å½“ä½œä¸€ä¸ªå•ç‹¬çš„æœªå¯¹é½çš„ <code>u16</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> arr <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span><span style=color:#66d9ef>u8</span>, <span style=color:#ae81ff>2</span><span style=color:#66d9ef>u8</span>, <span style=color:#ae81ff>3</span><span style=color:#66d9ef>u8</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> ptr_u16 <span style=color:#f92672>=</span> (<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> arr[<span style=color:#ae81ff>1</span>]) <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> _ <span style=color:#66d9ef>as</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>mut</span> <span style=color:#66d9ef>u16</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>ptr_u16 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x123</span>;
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;{:#x}&#34;</span>, <span style=color:#f92672>*</span>ptr_u16);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„, <code>clippy</code> ä¼šæ•è·åˆ°è¿™ä¸ª, å¹¶ä¸”è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªé”™è¯¯.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo clippy
</span></span><span style=display:flex><span>    Checking enumpeek v0.1.0 <span style=color:#f92672>(</span>/home/amos/ftl/enumpeek<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>error: casting from <span style=color:#e6db74>`</span>*mut u8<span style=color:#e6db74>`</span> to a more-strictly-aligned pointer <span style=color:#f92672>(</span><span style=color:#e6db74>`</span>*mut u16<span style=color:#e6db74>`</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> &lt; <span style=color:#ae81ff>2</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> --&gt; src/main.rs:3:19
</span></span><span style=display:flex><span>  |
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> |     let ptr_u16 <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>&amp;mut arr<span style=color:#f92672>[</span>1<span style=color:#f92672>])</span> as *mut _ as *mut u16;
</span></span><span style=display:flex><span>  |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span></span><span style=display:flex><span>  |
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span> note: <span style=color:#e6db74>`</span><span style=color:#75715e>#[deny(clippy::cast_ptr_alignment)]` on by default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>=</span> help: <span style=color:#66d9ef>for</span> further information visit https://rust-lang.github.io/rust-clippy/master/index.html#cast_ptr_alignment
</span></span></code></pre></div><p>ä¸è¿‡è¿™åœ¨æˆ‘çš„ç”µè„‘ä¸Šä¾æ—§æ˜¯å¯ä»¥è¿è¡Œçš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cargo run -q
</span></span><span style=display:flex><span>0x123
</span></span></code></pre></div><p>æ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å†æ¬¡å…³æ³¨å¯¹é½å‘¢?</p><p>å¥½å§, è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„æ•…äº‹&mldr;</p><h2 id=æˆ‘ä»¬æƒ³è¦ä»€ä¹ˆ-å¯¹é½-æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å®ƒ-well>æˆ‘ä»¬æƒ³è¦ä»€ä¹ˆ? å¯¹é½! æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å®ƒ? Well&mldr;</h2><p>å›åˆ° <code>C</code> å‘æ˜çš„å¹´ä»£, é‚£ä¸ªæ—¶å€™æœ‰äº›å¤„ç†å™¨ä¸æ€ä¹ˆæ”¯æŒæ²¡æœ‰å¯¹é½è¿‡çš„å†…å­˜è®¿é—®.</p><p>å¯¹äºè¿™äº›å¤„ç†å™¨, æ²¡æœ‰å¯¹é½çš„å†…å­˜è®¿é—®å¯èƒ½ä¼šå¯¼è‡´<a class=link href=https://www.kernel.org/doc/Documentation/unaligned-memory-access.txt target=_blank rel=noopener>æŠ›å‡ºä¸€ä¸ªå¤„ç†å™¨é”™è¯¯</a>: å¼‚å¸¸å¤„ç†å™¨æˆ–è®¸èƒ½å¤Ÿæ­£å¸¸è®¿é—®ä¸€ä¸ªæ²¡æœ‰å¯¹é½çš„å†…å­˜, ä½†æ˜¯ä¼šæµªè´¹è¾ƒå¤šçš„æ€§èƒ½, æˆ–è€…æ˜¯å¹²è„†æ²¡æ³•è®¿é—®æœªå¯¹é½çš„å†…å­˜, ç„¶åç¨‹åºè¿è¡Œå°±è¢« abort äº†.</p><p>åœ¨å¦ä¸€äº›å¤„ç†å™¨æ¶æ„é‡Œ, åƒæ˜¯è‹±ç‰¹å°”çš„ &ldquo;Core 2&rdquo; ç³»åˆ—, é€šå¸¸ä¼šç”¨ä¸€äº›æ€§èƒ½æŸè€—æ¥æ”¯æŒæœªå¯¹é½çš„å†…å­˜.</p><p>æˆ‘æœ¬æ¥æƒ³åœ¨è¿™é‡Œæ”¾ä¸Šä¸€äº› microbenchmarks, ä½†æ˜¯å®ƒä»¬æœ‰æ—¶å€™ä¼šäº’ç›¸çŸ›ç›¾ - åŸºå‡†æµ‹è¯•æœ‰å¾ˆå¤šå½±å“å› ç´ . æœ‰äº›åŸºå‡†æµ‹è¯•æ˜¾ç¤ºæœ‰ 10% çš„æ€§èƒ½é™ä½, æœ‰äº›ä¼šé™ä½ 50%, æ˜¾ç„¶æœ‰å¾ˆå¤šä¼šå½±å“åˆ°å…³äºè®¿é—®æœªå¯¹é½å†…å­˜çš„æ€§èƒ½æµ‹è¯•.</p><p>ä½†æ˜¯è¯·è®°ä½, å³ä½¿å¤„ç†å™¨å¼€å§‹å¯¹æœªå¯¹é½å†…å­˜åšäº†ä¸€çº§æ”¯æŒ, ä½†æ˜¯å‡ºäºæ€§èƒ½åŸå› ä»ç„¶è¦é¿å…ä½¿ç”¨æœªå¯¹é½å†…å­˜.</p><p>æˆ‘é€šå¸¸æŠŠæœ€å¥½çš„ä¸œè¥¿ç•™åˆ°æœ€åè¯´ ä½†æ˜¯:</p><p>ä¸€äº›æ¶æ„å¯èƒ½ä¸ä¼šæŠ›å‡ºå¤„ç†å™¨å¼‚å¸¸, è€Œæ˜¯é™é»˜åœ°æ‰§è¡Œä¸€äº›ä¸åŒçš„è¯»æ“ä½œ.</p><p><img src=/post/translation/rust/peeking_inside_a_rust_enum/armv4t.jpg width=640 height=518 srcset="/post/translation/rust/peeking_inside_a_rust_enum/armv4t_hub50016a2bde62f69b78292ec788779b2_120594_480x0_resize_q75_box.jpg 480w, /post/translation/rust/peeking_inside_a_rust_enum/armv4t_hub50016a2bde62f69b78292ec788779b2_120594_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt="An example ARMv4t chip: the sound processor chip for the SEGA NAOMI arcade system." class=gallery-image data-flex-grow=123 data-flex-basis=296px></p><h2 id=å¾ˆä¹…å¾ˆä¹…-åœ¨armv5ä»¥å‰>å¾ˆä¹…å¾ˆä¹…, åœ¨ARMv5ä»¥å‰&mldr;</h2><p>æˆ‘ä»¬å·²ç»åœ¨è¿™ç¯‡æ–‡ç« é‡Œè¯»äº†ä¸€äº›å…³äºæœªå¯¹é½å†…å­˜çš„å†…å®¹.</p><p>æ‰€ä»¥å±•ç¤ºä¸Šé¢æ‰€è¯´çš„ä¸åŒçš„è¯»æ“ä½œä¼šç›¸å¯¹æ¯”è¾ƒå®¹æ˜“.</p><p>é¦–å…ˆä½ éœ€è¦ä¸€äº›æ•°æ® - æˆ‘ä»¬åªç”¨äº† 8 ä¸ªä¸åŒçš„å­—èŠ‚å€¼, è¿™å¾ˆå®¹æ˜“ç†è§£åé¢å°†ä¼šå‘ç”Ÿä»€ä¹ˆ.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#66d9ef>uint8_t</span> arr[<span style=color:#ae81ff>8</span>] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0xef</span>, <span style=color:#ae81ff>0xcd</span>, <span style=color:#ae81ff>0xab</span>, <span style=color:#ae81ff>0x89</span>, <span style=color:#ae81ff>0x67</span>, <span style=color:#ae81ff>0x45</span>, <span style=color:#ae81ff>0x23</span>, <span style=color:#ae81ff>0x01</span> };
</span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬å»è¯»ä¸€ä¸ªæ²¡æœ‰å¯¹é½çš„åœ°å€. ä¸¾ä¸ªä¾‹å­, æˆ‘ä»¬å°è¯•ä»æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹è¯»å–ä¸€ä¸ª <code>uint32_t</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdint.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> arr[<span style=color:#ae81ff>8</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0xef</span>, <span style=color:#ae81ff>0xcd</span>, <span style=color:#ae81ff>0xab</span>, <span style=color:#ae81ff>0x89</span>, <span style=color:#ae81ff>0x67</span>, <span style=color:#ae81ff>0x45</span>, <span style=color:#ae81ff>0x23</span>, <span style=color:#ae81ff>0x01</span>};
</span></span><span style=display:flex><span>    <span style=color:#75715e>// arrays are zero-indexed, so `1` is the second item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint32_t</span> <span style=color:#f92672>*</span>ptr <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint32_t</span> <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>arr[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;0x%08x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#f92672>*</span>ptr);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>çŒœçŒœä¼šæ‰“å°ä»€ä¹ˆ? æ˜¯ <code>0xcdab8967</code>? é”™äº†!</p><p>æˆ‘2018å¹´çš„i7å¤„ç†å™¨æ˜¯ä¸€ä¸ªå°ç«¯å¤„ç†å™¨:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lscpu | grep -E <span style=color:#e6db74>&#39;(Byte Order|Model name)&#39;</span>
</span></span><span style=display:flex><span>Byte Order:                      Little Endian
</span></span><span style=display:flex><span>Model name:                      Intel<span style=color:#f92672>(</span>R<span style=color:#f92672>)</span> Core<span style=color:#f92672>(</span>TM<span style=color:#f92672>)</span> i7-8750H CPU @ 2.20GHz
</span></span></code></pre></div><p>è¿™æ„å‘³ç€å­—èŠ‚æ˜¯ä»æœ€ä½æœ‰æ•ˆå€¼å­˜å‚¨åˆ°æœ€é«˜æœ‰æ•ˆå€¼.</p><p>æ‰€ä»¥ä¸å…¶è¯´æ˜¯è¿™æ ·å­çš„:</p><p>å…¶å®æ˜¯è¿™æ ·å­çš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ gcc -Wall main.c -o main <span style=color:#f92672>&amp;&amp;</span> ./main
</span></span><span style=display:flex><span>0x6789abcd
</span></span></code></pre></div><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¸ºæˆ‘çš„æ•°ç»„é€‰äº†è¿™äº›å¥½è¾¨è¯†çš„å€¼çš„åŸå› .</p><p><img src=/post/translation/rust/peeking_inside_a_rust_enum/gba.jpg width=1280 height=884 srcset="/post/translation/rust/peeking_inside_a_rust_enum/gba_hu302f1c2d37f956d6cc8b3c35003135c9_97592_480x0_resize_q75_box.jpg 480w, /post/translation/rust/peeking_inside_a_rust_enum/gba_hu302f1c2d37f956d6cc8b3c35003135c9_97592_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt="A &lsquo;Glacier&rsquo; Game Boy Advance - one of the colors available at launch in North America" class=gallery-image data-flex-grow=144 data-flex-basis=347px></p><p>| <a class=link href=https://devkitpro.org/wiki/Getting_Started target=_blank rel=noopener>devKitPro</a></p><p>æˆ‘ä»¥å‰ä¹Ÿæ²¡è¯»è¿‡å…³äºGBAå¼€å‘çš„ç›¸å…³æ–‡æ¡£, æˆ‘åªæ˜¯æ‰¾äº†ä¸ªé¡¹ç›®<a class=link href=https://vba-m.com/ target=_blank rel=noopener>VisualBoyAdvance</a>:</p><p><img src=/post/translation/rust/peeking_inside_a_rust_enum/gba-hello.png width=480 height=349 srcset="/post/translation/rust/peeking_inside_a_rust_enum/gba-hello_hu374745a0a15a6dd857febbf559df6352_9948_480x0_resize_box_3.png 480w, /post/translation/rust/peeking_inside_a_rust_enum/gba-hello_hu374745a0a15a6dd857febbf559df6352_9948_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=137 data-flex-basis=330px></p><p>è¿™ä¸ªé¡¹ç›®çš„ <code>C</code> ä»£ç çœ‹èµ·æ¥å¦‚ä¸‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#75715e>// (cut)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// clear screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    iprintf(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>[2J&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// print at coordinates 10,10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    iprintf(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>[10;10H&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    iprintf(<span style=color:#e6db74>&#34;Hello World!&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// (cut)
</span></span></span></code></pre></div><p>So - è¶³å¤Ÿç®€å•äº†!ä»–æœ‰ä¸€äº›è‡ªå·±çš„ <code>printf</code> å®ç° - é™¤æ­¤ä¹‹å¤–, è¿™å°±åªæ˜¯ <code>C</code>! ç„¶ååŒæ ·ç”¨ <code>GCC</code> ç¼–è¯‘.</p><p>æ‰€ä»¥è®©æˆ‘ä»¬çš„ä»£ç è·‘èµ·æ¥å¹¶ä¸æ˜¯<strong>å¾ˆéš¾</strong>.</p><p>ä»¥ä¸‹æ˜¯å®Œæ•´çš„ä»£ç  <code>source/console.c</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;gba_console.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;gba_video.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;gba_interrupt.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;gba_systemcalls.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    irqInit();
</span></span><span style=display:flex><span>    irqEnable(IRQ_VBLANK);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    consoleDemoInit();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// clear screen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    iprintf(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>[2J&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// print at coordinates 10,10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    iprintf(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x1b</span><span style=color:#e6db74>[10;10H&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> arr[<span style=color:#ae81ff>8</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0xef</span>, <span style=color:#ae81ff>0xcd</span>, <span style=color:#ae81ff>0xab</span>, <span style=color:#ae81ff>0x89</span>, <span style=color:#ae81ff>0x67</span>, <span style=color:#ae81ff>0x45</span>, <span style=color:#ae81ff>0x23</span>, <span style=color:#ae81ff>0x01</span>};
</span></span><span style=display:flex><span>    <span style=color:#75715e>// arrays are zero-indexed, so `1` is the second item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>uint32_t</span> <span style=color:#f92672>*</span>ptr <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint32_t</span> <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>arr[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    iprintf(<span style=color:#e6db74>&#34;0x%08x&#34;</span>, <span style=color:#f92672>*</span>ptr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        VBlankIntrWait();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><footer class=article-footer><section class=article-tags><a href=/tags/translation/>Translation</a>
<a href=/tags/rust/>Rust</a>
<a href=/tags/enum/>Enum</a></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>Last updated on Jan 13, 2021 15:00 +0800</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/post/translation/rust/green_threads_explained_in_200_lines_of_rust/><div class=article-image><img src=/post/translation/rust/green_threads_explained_in_200_lines_of_rust/cover.6e5456ddb6c6b4a991a552f76e413144_hud99fec317f0d171bfccb5e21f0f08cf5_179342_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 200è¡ŒRustä»£ç è§£é‡Šç»¿è‰²çº¿ç¨‹" data-key=green_threads_explained_in_200_lines_of_rust data-hash="md5-blRW3bbGtKmRpVL3bkExRA=="></div><div class=article-details><h2 class=article-title>200è¡ŒRustä»£ç è§£é‡Šç»¿è‰²çº¿ç¨‹</h2></div></a></article><article class=has-image><a href=/post/rust/elegent_rust/><div class=article-image><img src=/post/rust/elegent_rust/cover.5260949b1ad39a8dea97c4e453c35e3b_hu99bb65b34be40363fd484c863e327c7b_227902_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post ä¼˜é›…çš„Rust" data-key=elegent_rust data-hash="md5-UmCUmxrTmo3ql8TkU8NeOw=="></div><div class=article-details><h2 class=article-title>ä¼˜é›…çš„Rust</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2022</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>